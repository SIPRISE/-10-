<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Activity System ‚Äî LoliLand Edition</title>

  <!-- Firebase compat (–∫–∞–∫ —É —Ç–µ–±—è) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#060812;
      --bg2:#0a1026;
      --card:#0b122b;
      --card2:#0a1638;
      --border:#1b2a55;
      --text:#e6ecff;

      --accent:#7c3aed;   /* LoliLand purple */
      --accent2:#22d3ee;  /* neon cyan */
      --success:#10b981;
      --warn:#facc15;
      --danger:#ef4444;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --glow: 0 0 0 1px rgba(124,58,237,.25), 0 0 38px rgba(124,58,237,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:22px;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.22), transparent 55%),
                  radial-gradient(1000px 700px at 85% 20%, rgba(34,211,238,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }

    .wrap{max-width:1600px; margin:0 auto;}
    .card{
      background: linear-gradient(180deg, rgba(11,18,43,.92), rgba(8,14,36,.92));
      border:1px solid rgba(27,42,85,.9);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:18px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      border-bottom:1px solid rgba(27,42,85,.8);
      background: linear-gradient(90deg, rgba(124,58,237,.16), rgba(34,211,238,.10));
    }

    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title h2{
      margin:0;
      font-size:18px;
      letter-spacing:.4px;
    }
    .title .sub{
      font-size:12px;
      color:rgba(230,236,255,.75);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      background: rgba(124,58,237,.14);
      border:1px solid rgba(124,58,237,.30);
      border-radius:999px;
      box-shadow: var(--glow);
      font-size:12px;
      white-space:nowrap;
    }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:12px;
      padding:16px 18px;
      border-bottom:1px solid rgba(27,42,85,.7);
      background: rgba(6,8,18,.35);
      align-items:flex-end;
    }

    .group{display:flex; flex-direction:column; gap:6px;}
    .group label{
      font-size:11px; font-weight:900;
      letter-spacing:.6px;
      color: rgba(34,211,238,.95);
      text-transform:uppercase;
    }
    input, select{
      min-height:40px;
      background: rgba(10,16,38,.9);
      color: var(--text);
      border:1px solid rgba(27,42,85,.9);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    input:focus, select:focus{
      border-color: rgba(34,211,238,.85);
      box-shadow: 0 0 0 3px rgba(34,211,238,.12);
    }

    button{
      cursor:pointer;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:900;
      letter-spacing:.2px;
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      min-height:40px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    .btn-primary{ background: linear-gradient(90deg, var(--accent), #a78bfa); color:white; }
    .btn-success{ background: linear-gradient(90deg, var(--success), #34d399); color:#052016; }
    .btn-warn{ background: linear-gradient(90deg, var(--warn), #fde68a); color:#2a2100; }
    .btn-danger{ background: linear-gradient(90deg, var(--danger), #fb7185); color:#2a040b; }
    .btn-ghost{
      background: rgba(230,236,255,.06);
      border:1px solid rgba(230,236,255,.12);
      color: rgba(230,236,255,.9);
    }
    .spacer{ margin-left:auto; }

    .table-wrap{
      overflow:auto;
      border-top:1px solid rgba(27,42,85,.65);
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1200px;
      background: rgba(10,16,38,.55);
    }
    th, td{
      border:1px solid rgba(27,42,85,.7);
      padding:12px;
      text-align:center;
      min-width:120px;
      font-size:13px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:7;
      background: rgba(11,18,43,.95);
      backdrop-filter: blur(10px);
    }

    .sticky-col{
      position:sticky;
      left:0;
      z-index:8;
      text-align:left;
      font-weight:900;
      background: rgba(6,8,18,.92);
    }

    .badge{
      padding:5px 10px;
      border-radius:10px;
      font-size:11px;
      text-transform:uppercase;
      font-weight:1000;
      color:white;
      display:inline-block;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 0 0 1px rgba(0,0,0,.22);
      white-space:nowrap;
    }
    /* —Ä–æ–ª–∏ */
    .role-8{ background: linear-gradient(90deg, #2563eb, #60a5fa);} /* –ê–¥–º–∏–Ω */
    .role-7{ background: linear-gradient(90deg, #10b981, #34d399);} /* –°—Ç. –ê–¥–º–∏–Ω */
    .role-6{ background: linear-gradient(90deg, #a855f7, #c4b5fd);} /* –ú–ª. –ê–¥–º–∏–Ω */
    .role-5{ background: linear-gradient(90deg, #ec4899, #f9a8d4);} /* –°—Ç. –ú–æ–¥–µ—Ä */
    .role-3{ background: linear-gradient(90deg, #38bdf8, #7dd3fc);} /* –ú–ª. –ú–æ–¥–µ—Ä */
    .role-2{ background: linear-gradient(90deg, #f97316, #fdba74);} /* –°—Ç. –•–µ–ª–ø–µ—Ä */
    .role-1{ background: linear-gradient(90deg, #14b8a6, #5eead4);} /* –•–µ–ª–ø–µ—Ä */

    .cell-input{
      width:72px;
      background: rgba(230,236,255,.06);
      border:1px solid rgba(230,236,255,.10);
      color:var(--text);
      text-align:center;
      padding:7px 8px;
      border-radius:9px;
      font-weight:900;
    }

    .muted{ color: rgba(230,236,255,.62); font-weight:700; }
    .sum-row td{
      background: rgba(6,8,18,.92) !important;
      color: var(--warn);
      font-weight:1000;
    }
    .sum-sub td{
      background: rgba(6,8,18,.80) !important;
      color: rgba(230,236,255,.85);
      font-weight:900;
    }

    .right{
      text-align:right;
    }
    .note{
      padding:14px 18px;
      border-top:1px solid rgba(27,42,85,.65);
      color: rgba(230,236,255,.68);
      font-size:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background: rgba(6,8,18,.32);
    }

    /* —Å–∫—Ä—ã—Ç–∏–µ –∞–¥–º–∏–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
    body.role-viewer .admin-only{ display:none !important; }
    body.role-viewer .cell-input{ pointer-events:none; opacity:.65; }
    body.role-editor .super-only{ display:none !important; }
    .danger-text{ color: #fb7185; font-weight:900; }
  </style>
</head>

<body class="role-viewer">
<div class="wrap">
  <div class="card">

    <div class="header">
      <div class="title">
        <h2 id="hdr">–£—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–∞ ‚Äî LoliLand</h2>
        <div class="sub" id="who">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
      </div>
      <div class="pill" id="weekPill">–ù–µ–¥–µ–ª—è: ‚Äî</div>
    </div>

    <!-- AUTH BAR -->
    <div class="toolbar" id="authBar">
      <div class="group">
        <label>Email</label>
        <input id="email" type="email" placeholder="name@domain.com" autocomplete="username">
      </div>
      <div class="group">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="btn-primary" onclick="signIn()">üîê –í–æ–π—Ç–∏</button>
      <button class="btn-ghost" onclick="signUp()">üßæ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <div class="spacer"></div>
      <button class="btn-ghost" onclick="signOut()">üö™ –í—ã–π—Ç–∏</button>
    </div>

    <!-- MAIN TOOLBAR -->
    <div class="toolbar admin-only" id="mainBar">
      <div class="group">
        <label>–ù–µ–¥–µ–ª—è (–Ω–∞—á–∞–ª–æ)</label>
        <input type="date" id="weekStart" onchange="selectWeekFromDate()">
      </div>

      <div class="group">
        <label>–ê—Ä—Ö–∏–≤ –Ω–µ–¥–µ–ª—å</label>
        <select id="weekSelect" onchange="loadSelectedWeek()">
          <option value="">‚Äî</option>
        </select>
      </div>

      <div class="group">
        <label>–ù–∏–∫–Ω–µ–π–º</label>
        <input type="text" id="nickname" placeholder="Nickname">
      </div>

      <div class="group">
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <select id="role">
          <option value="7">–°—Ç–∞—Ä—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="8">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="6">–ú–ª–∞–¥—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="5">–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
          <option value="3">–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
          <option value="2">–°—Ç–∞—Ä—à–∏–π –•–µ–ª–ø–µ—Ä</option>
          <option value="1">–•–µ–ª–ø–µ—Ä</option>
        </select>
      </div>

      <button class="btn-primary" onclick="addPerson()">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="btn-success" onclick="saveWeek()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn-warn" onclick="exportToExcel()">üì• Export</button>

      <div class="spacer"></div>

      <button class="btn-ghost super-only" onclick="openUsersPanel()">üëë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
      <button class="btn-danger super-only" onclick="clearWeek()">üóë –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é</button>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="mainTable">
        <thead>
          <tr id="roleRow"><th class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th></tr>
          <tr id="nickRow"><th class="sticky-col">–ù–∏–∫–Ω–µ–π–º</th></tr>
        </thead>
        <tbody id="bodyRows"></tbody>

        <!-- –∏—Ç–æ–≥–∏ –ø–æ —Å–∫—Ä–∏–Ω–∞–º -->
        <tfoot>
          <tr class="sum-row" id="sumScreensRow"><td class="sticky-col">–ò–¢–û–ì–û –°–ö–†–ò–ù–û–í (7 –¥–Ω–µ–π)</td></tr>
          <tr class="sum-sub" id="sumOnlineRow"><td class="sticky-col">Œ£ –û–Ω–ª–∞–π–Ω</td></tr>
          <tr class="sum-sub" id="sumMutesRow"><td class="sticky-col">Œ£ –ú—É—Ç—ã</td></tr>
          <tr class="sum-sub" id="sumBansRow"><td class="sticky-col">Œ£ –ë–∞–Ω—ã</td></tr>
          <tr class="sum-sub" id="sumTicketsRow"><td class="sticky-col">Œ£ –¢–∏–∫–µ—Ç—ã</td></tr>
          <tr class="sum-sub" id="sumRatingRow"><td class="sticky-col">–†–µ–π—Ç–∏–Ω–≥</td></tr>
        </tfoot>
      </table>
    </div>

    <div class="note">
      <div>
        <span class="muted">–†–µ–π—Ç–∏–Ω–≥:</span>
        <span class="muted">–û–Ω–ª–∞–π–Ω√ó1 + –ú—É—Ç—ã√ó2 + –ë–∞–Ω—ã√ó3 + –¢–∏–∫–µ—Ç—ã√ó1.5</span>
      </div>
      <div class="muted">–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è (–¥–ª—è —Ä–æ–ª–µ–π ‚â• –ú–ª.–ê–¥–º–∏–Ω).</div>
    </div>
  </div>
</div>

<!-- USERS PANEL (–ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–∞–ª–∫–∞) -->
<div id="usersModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px); z-index:9999;">
  <div style="max-width:980px; margin:40px auto; background:rgba(11,18,43,.95); border:1px solid rgba(27,42,85,.9); border-radius:16px; box-shadow: var(--shadow); overflow:hidden;">
    <div style="padding:16px 18px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(27,42,85,.7);">
      <div style="font-weight:1000;">üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
      <button class="btn-ghost" onclick="closeUsersPanel()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div style="padding:16px 18px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
      <div class="group">
        <label>UID</label>
        <input id="u_uid" placeholder="uid –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
      </div>
      <div class="group">
        <label>–ù–∏–∫</label>
        <input id="u_nick" placeholder="–Ω–∏–∫ –≤ —Å–∏—Å—Ç–µ–º–µ">
      </div>
      <div class="group">
        <label>–†–æ–ª—å</label>
        <select id="u_role">
          <option value="8">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (8)</option>
          <option value="7">–°—Ç–∞—Ä—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (7)</option>
          <option value="6">–ú–ª–∞–¥—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (6)</option>
          <option value="5">–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (5)</option>
          <option value="3">–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (3)</option>
          <option value="2">–°—Ç–∞—Ä—à–∏–π –•–µ–ª–ø–µ—Ä (2)</option>
          <option value="1">–•–µ–ª–ø–µ—Ä (1)</option>
          <option value="0">Viewer (0)</option>
        </select>
      </div>
      <button class="btn-primary" onclick="setUserRole()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

      <div class="spacer"></div>
      <div class="muted">
        –í–∞–∂–Ω–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–µ–Ω —Å–∞–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è/–≤–æ–π—Ç–∏, —á—Ç–æ–±—ã —É –Ω–µ–≥–æ –ø–æ—è–≤–∏–ª—Å—è UID.
      </div>
    </div>

    <div style="padding:0 18px 18px 18px;">
      <div class="muted" style="margin-bottom:10px;">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (roles):</div>
      <div style="overflow:auto; border:1px solid rgba(27,42,85,.7); border-radius:12px;">
        <table style="width:100%; border-collapse:collapse; min-width:760px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(27,42,85,.7);">UID</th>
              <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(27,42,85,.7);">–ù–∏–∫</th>
              <th style="text-align:center; padding:10px; border-bottom:1px solid rgba(27,42,85,.7);">–†–æ–ª—å</th>
            </tr>
          </thead>
          <tbody id="usersList"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  authDomain: "aktiv-d4d72.firebaseapp.com",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
  storageBucket: "aktiv-d4d72.firebasestorage.app",
  messagingSenderId: "714513253285",
  appId: "1:714513253285:web:c76d9fec18593db9a55e4c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* =========================
   CONSTANTS / HELPERS
========================= */
const ROLE_NAMES = {
  8: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
  7: "–°—Ç–∞—Ä—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
  6: "–ú–ª–∞–¥—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
  5: "–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
  3: "–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
  2: "–°—Ç–∞—Ä—à–∏–π –•–µ–ª–ø–µ—Ä",
  1: "–•–µ–ª–ø–µ—Ä",
  0: "Viewer"
};
const ROLE_BADGE_CLASS = (role) => `role-${role}`;

const WEIGHTS = { online: 1, mutes: 2, bans: 3, tickets: 1.5 };

// state
let currentUser = null;
let currentRole = 0;
let currentNick = "‚Äî";

let currentWeekKey = "";      // e.g. 2026-02-19
let weekData = null;          // structured
let unsubWeek = null;

function weekKeyFromDate(dateStr){
  // dateStr = YYYY-MM-DD
  return dateStr || "";
}
function formatWeekPill(dateStr){
  if(!dateStr) return "–ù–µ–¥–µ–ª—è: ‚Äî";
  const d = new Date(dateStr + "T00:00:00");
  const ru = d.toLocaleDateString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit"});
  return `–ù–µ–¥–µ–ª—è: ${ru}`;
}
function canEdit(){
  return currentRole >= 6; // –ú–ª.–ê–¥–º–∏–Ω+
}
function canManageUsers(){
  return currentRole >= 7; // –°—Ç.–ê–¥–º–∏–Ω+
}
function setBodyRoleClass(){
  document.body.classList.remove("role-viewer","role-editor","role-super");
  if(currentRole >= 7) document.body.classList.add("role-super");
  else if(currentRole >= 6) document.body.classList.add("role-editor");
  else document.body.classList.add("role-viewer");
}

/* =========================
   AUTH
========================= */
async function signIn(){
  const email = document.getElementById("email").value.trim();
  const pass  = document.getElementById("pass").value;
  if(!email || !pass) return alert("–í–≤–µ–¥–∏ email –∏ –ø–∞—Ä–æ–ª—å.");
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
  }
}

async function signUp(){
  const email = document.getElementById("email").value.trim();
  const pass  = document.getElementById("pass").value;
  if(!email || !pass) return alert("–í–≤–µ–¥–∏ email –∏ –ø–∞—Ä–æ–ª—å.");
  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ—Å–∏ –°—Ç.–ê–¥–º–∏–Ω–∞ –≤—ã–¥–∞—Ç—å —Ä–æ–ª—å (–∏–Ω–∞—á–µ –±—É–¥–µ—Ç Viewer).");
  }catch(e){
    alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + e.message);
  }
}

async function signOut(){
  await auth.signOut();
}

auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  if(!user){
    currentRole = 0;
    currentNick = "‚Äî";
    document.getElementById("who").innerHTML = `<span class="danger-text">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>`;
    document.getElementById("weekPill").innerText = "–ù–µ–¥–µ–ª—è: ‚Äî";
    setBodyRoleClass();
    renderEmptyTable();
    stopWeekSub();
    return;
  }

  // load profile
  const snap = await db.ref("users/" + user.uid).get();
  const prof = snap.exists() ? snap.val() : null;
  currentRole = prof?.role ?? 0;
  currentNick = prof?.nickname ?? user.email ?? "User";

  document.getElementById("who").innerText = `${currentNick} ‚Ä¢ ${ROLE_NAMES[currentRole] ?? "‚Äî"} ‚Ä¢ UID: ${user.uid}`;
  setBodyRoleClass();

  // ensure user node exists
  if(!snap.exists()){
    await db.ref("users/" + user.uid).set({ nickname: currentNick, role: 0, createdAt: Date.now() });
  }

  await loadWeeksList();
  // auto-select current week by Monday? (–±–µ—Ä—ë–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É)
  const today = new Date();
  const monday = new Date(today);
  const day = (today.getDay() + 6) % 7; // Mon=0
  monday.setDate(today.getDate() - day);
  const iso = monday.toISOString().slice(0,10);
  document.getElementById("weekStart").value = iso;
  selectWeekFromDate();
});

/* =========================
   WEEKS LIST (ARCHIVE)
========================= */
async function loadWeeksList(){
  const sel = document.getElementById("weekSelect");
  sel.innerHTML = `<option value="">‚Äî</option>`;
  const snap = await db.ref("activity").get();
  if(!snap.exists()) return;
  const keys = Object.keys(snap.val()).sort().reverse();
  for(const k of keys){
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    sel.appendChild(opt);
  }
}

function loadSelectedWeek(){
  const k = document.getElementById("weekSelect").value;
  if(!k) return;
  document.getElementById("weekStart").value = k;
  selectWeekFromDate();
}

function selectWeekFromDate(){
  const dateStr = document.getElementById("weekStart").value;
  const k = weekKeyFromDate(dateStr);
  if(!k) return;
  currentWeekKey = k;
  document.getElementById("weekPill").innerText = formatWeekPill(k);
  subscribeWeek(k);
}

/* =========================
   DATA MODEL (STRUCTURED)
========================= */
/*
activity/{weekKey} = {
  weekStart: "YYYY-MM-DD",
  people: [{id, nick, role}],
  days: [ "YYYY-MM-DD"...7 ],
  metrics: ["online","mutes","bans","tickets"],
  entries: { [personId]: { [dayIndex]: {online,mutes,bans,tickets} } },
  updatedAt
}
logs/{weekKey}/{push} = { ts, uid, nick, action, payload }
*/

function buildDefaultWeek(weekKey){
  const base = new Date(weekKey + "T00:00:00");
  const days = [];
  for(let i=0;i<7;i++){
    const d = new Date(base);
    d.setDate(base.getDate()+i);
    days.push(d.toISOString().slice(0,10));
  }
  return {
    weekStart: weekKey,
    days,
    metrics: ["online","mutes","bans","tickets"],
    people: [],
    entries: {},
    updatedAt: Date.now()
  };
}

function stopWeekSub(){
  if(unsubWeek){
    unsubWeek.off();
    unsubWeek = null;
  }
}

function subscribeWeek(weekKey){
  stopWeekSub();
  const ref = db.ref("activity/" + weekKey);
  unsubWeek = ref;

  ref.on("value", (snap)=>{
    weekData = snap.exists() ? snap.val() : buildDefaultWeek(weekKey);
    renderWeek();
  });
}

/* =========================
   RENDER TABLE
========================= */
function renderEmptyTable(){
  document.getElementById("roleRow").innerHTML = `<th class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>`;
  document.getElementById("nickRow").innerHTML = `<th class="sticky-col">–ù–∏–∫–Ω–µ–π–º</th>`;
  document.getElementById("bodyRows").innerHTML = "";
  ["sumScreensRow","sumOnlineRow","sumMutesRow","sumBansRow","sumTicketsRow","sumRatingRow"].forEach(id=>{
    document.getElementById(id).innerHTML = `<td class="sticky-col">${document.getElementById(id).cells?.[0]?.innerText || ""}</td>`;
  });
}

function renderWeek(){
  if(!weekData) return;
  const people = weekData.people || [];
  const days = weekData.days || [];
  const body = document.getElementById("bodyRows");

  // header rows
  const roleRow = document.getElementById("roleRow");
  const nickRow = document.getElementById("nickRow");
  roleRow.innerHTML = `<th class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>`;
  nickRow.innerHTML = `<th class="sticky-col">–ù–∏–∫–Ω–µ–π–º</th>`;

  for(const p of people){
    roleRow.innerHTML += `<th><span class="badge ${ROLE_BADGE_CLASS(p.role)}">${ROLE_NAMES[p.role] ?? p.role}</span></th>`;
    nickRow.innerHTML += `<th title="${escapeHtml(p.nick)}">${escapeHtml(p.nick)}</th>`;
  }

  // rows: 7 –¥–Ω–µ–π + 4 –º–µ—Ç—Ä–∏–∫–∏
  let html = "";

  // 7 days (for "screens" total we count sum of all metrics? –ù–ï–¢: –∫–∞–∫ –≤ —Ç–≤–æ—ë–º ‚Äî —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ –∑–∞ –¥–µ–Ω—å (—Å–∫—Ä–∏–Ω—ã) -> –¥–µ–ª–∞–µ–º —Å—É–º–º–æ–π –≤—Å–µ—Ö 4 –º–µ—Ç—Ä–∏–∫ –∑–∞ –¥–µ–Ω—å)
  for(let i=0;i<7;i++){
    const d = new Date(days[i] + "T00:00:00");
    const fmt = d.toLocaleDateString("ru-RU",{weekday:"short",day:"2-digit",month:"2-digit"});
    html += `<tr><td class="sticky-col" style="color: rgba(34,211,238,.95)">${fmt}</td>`;
    for(const p of people){
      const cell = getEntry(p.id, i);
      const dayScreens = (cell.online||0)+(cell.mutes||0)+(cell.bans||0)+(cell.tickets||0);
      html += `<td>${renderInput(p.id, i, "screens", dayScreens, true)}</td>`;
    }
    html += `</tr>`;
  }

  // metrics rows
  const metricRows = [
    {key:"online", label:"üìä –û–Ω–ª–∞–π–Ω"},
    {key:"mutes", label:"üö´ –ú—É—Ç—ã"},
    {key:"bans", label:"üî® –ë–∞–Ω—ã"},
    {key:"tickets", label:"üì© –¢–∏–∫–µ—Ç—ã"}
  ];

  for(const m of metricRows){
    html += `<tr><td class="sticky-col" style="color:rgba(230,236,255,.65)">${m.label}</td>`;
    for(const p of people){
      const sum = sumMetric(p.id, m.key);
      html += `<td class="muted">${sum}</td>`;
    }
    html += `</tr>`;
  }

  body.innerHTML = html;

  // totals footer
  renderTotals();

  // lock inputs for viewers
  if(canEdit()){
    bindScreensInputs();
  }
}

function renderTotals(){
  const people = weekData.people || [];

  const sumScreensRow = document.getElementById("sumScreensRow");
  const sumOnlineRow  = document.getElementById("sumOnlineRow");
  const sumMutesRow   = document.getElementById("sumMutesRow");
  const sumBansRow    = document.getElementById("sumBansRow");
  const sumTicketsRow = document.getElementById("sumTicketsRow");
  const sumRatingRow  = document.getElementById("sumRatingRow");

  sumScreensRow.innerHTML = `<td class="sticky-col">–ò–¢–û–ì–û –°–ö–†–ò–ù–û–í (7 –¥–Ω–µ–π)</td>`;
  sumOnlineRow.innerHTML  = `<td class="sticky-col">Œ£ –û–Ω–ª–∞–π–Ω</td>`;
  sumMutesRow.innerHTML   = `<td class="sticky-col">Œ£ –ú—É—Ç—ã</td>`;
  sumBansRow.innerHTML    = `<td class="sticky-col">Œ£ –ë–∞–Ω—ã</td>`;
  sumTicketsRow.innerHTML = `<td class="sticky-col">Œ£ –¢–∏–∫–µ—Ç—ã</td>`;
  sumRatingRow.innerHTML  = `<td class="sticky-col">–†–µ–π—Ç–∏–Ω–≥</td>`;

  for(const p of people){
    const online = sumMetric(p.id,"online");
    const mutes = sumMetric(p.id,"mutes");
    const bans = sumMetric(p.id,"bans");
    const tickets = sumMetric(p.id,"tickets");
    const screens = online+mutes+bans+tickets; // —Å—É–º–º–∞—Ä–Ω—ã–µ —Å–∫—Ä–∏–Ω—ã –Ω–µ–¥–µ–ª–∏
    const rating = (online*WEIGHTS.online) + (mutes*WEIGHTS.mutes) + (bans*WEIGHTS.bans) + (tickets*WEIGHTS.tickets);

    sumScreensRow.innerHTML += `<td>${screens}</td>`;
    sumOnlineRow.innerHTML  += `<td>${online}</td>`;
    sumMutesRow.innerHTML   += `<td>${mutes}</td>`;
    sumBansRow.innerHTML    += `<td>${bans}</td>`;
    sumTicketsRow.innerHTML += `<td>${tickets}</td>`;
    sumRatingRow.innerHTML  += `<td><b>${round1(rating)}</b></td>`;
  }
}

function round1(x){ return Math.round(x*10)/10; }

function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

/* =========================
   SCREEN INPUTS (EDIT DAYS)
   –í–≤–æ–¥–∏–º "—Å–∫—Ä–∏–Ω—ã" –∑–∞ –¥–µ–Ω—å –æ–¥–Ω–∏–º —á–∏—Å–ª–æ–º,
   –∞ –ø–æ—Ç–æ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º —á–µ—Ä–µ–∑ –±—ã—Å—Ç—Ä—ã–π –ø–æ–ø–∞–ø? (—Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ)
   –ü–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ:
   - –ù–∞ –∫–∞–∂–¥–æ–º –¥–Ω–µ –≤–≤–æ–¥–∏—Ç—Å—è –û–ë–©–ï–ï —á–∏—Å–ª–æ —Å–∫—Ä–∏–Ω–æ–≤
   - –ü—Ä–∏ –≤–≤–æ–¥–µ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ entries[dayIndex].screens
   - –ò –æ—Ç–¥–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º breakdown online/mutes/bans/tickets —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ–æ—Ä–º—É? (–Ω–µ –ø—Ä–æ—Å–∏–ª–∏)
   ----
   –ù–æ —Ç—ã –ø—Ä–æ—Å–∏–ª –∞–≤—Ç–æ–ø–æ–¥—Å—á—ë—Ç –º—É—Ç–æ–≤/–±–∞–Ω–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ.
   –ó–Ω–∞—á–∏—Ç: –Ω–∞–¥–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ online/mutes/bans/tickets –ø–æ –¥–Ω—è–º.
   –ü–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º —Ç–∞–∫:
   - –∫–ª–∏–∫–∞–µ—à—å –Ω–∞ "—Å–∫—Ä–∏–Ω—ã" –¥–Ω—è -> –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–∏–Ω–∏-—Ä–µ–¥–∞–∫—Ç–æ—Ä 4 —á–∏—Å–µ–ª
========================= */

function renderInput(pid, dayIndex, type, value, isDayScreens){
  const disabled = canEdit() ? "" : "disabled";
  // input —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ total, –Ω–æ –ø–æ –∫–ª–∏–∫—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º editor
  return `<input ${disabled} class="cell-input" type="number" min="0" value="${value||0}"
          data-pid="${pid}" data-day="${dayIndex}" onclick="openDayEditor(event)"
          onkeydown="if(event.key==='Enter'){this.blur();}">`;
}

function bindScreensInputs(){
  // nothing additional now; click handler inline
}

function getEntry(pid, dayIndex){
  const e = weekData.entries?.[pid]?.[dayIndex];
  return e ? {online:+e.online||0, mutes:+e.mutes||0, bans:+e.bans||0, tickets:+e.tickets||0} : {online:0,mutes:0,bans:0,tickets:0};
}

function sumMetric(pid, key){
  let sum = 0;
  for(let i=0;i<7;i++){
    sum += (getEntry(pid,i)[key]||0);
  }
  return sum;
}

/* =========================
   DAY EDITOR (4 –ø–æ–ª—è)
========================= */
function openDayEditor(ev){
  if(!canEdit()) return;
  const inp = ev.target;
  const pid = inp.dataset.pid;
  const day = +inp.dataset.day;

  const current = getEntry(pid, day);

  const online = prompt("–û–Ω–ª–∞–π–Ω –∑–∞ –¥–µ–Ω—å:", current.online);
  if(online === null) return;

  const mutes = prompt("–ú—É—Ç—ã –∑–∞ –¥–µ–Ω—å:", current.mutes);
  if(mutes === null) return;

  const bans = prompt("–ë–∞–Ω—ã –∑–∞ –¥–µ–Ω—å:", current.bans);
  if(bans === null) return;

  const tickets = prompt("–¢–∏–∫–µ—Ç—ã –∑–∞ –¥–µ–Ω—å:", current.tickets);
  if(tickets === null) return;

  const next = {
    online: Math.max(0, parseInt(online)||0),
    mutes: Math.max(0, parseInt(mutes)||0),
    bans: Math.max(0, parseInt(bans)||0),
    tickets: Math.max(0, parseInt(tickets)||0)
  };

  // set and save
  setEntry(pid, day, next);
}

function setEntry(pid, dayIndex, obj){
  if(!weekData.entries) weekData.entries = {};
  if(!weekData.entries[pid]) weekData.entries[pid] = {};
  weekData.entries[pid][dayIndex] = obj;
  weekData.updatedAt = Date.now();

  // optimistic render
  renderWeek();

  // log + save
  logAction("setEntry", { pid, dayIndex, obj });
  saveWeek();
}

/* =========================
   CRUD PEOPLE
========================= */
function addPerson(){
  if(!canEdit()) return alert("–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω—É–∂–µ–Ω –ú–ª.–ê–¥–º–∏–Ω+).");
  const nick = document.getElementById("nickname").value.trim();
  const role = parseInt(document.getElementById("role").value,10);
  if(!nick) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫.");

  const id = "p_" + Date.now();

  weekData.people.push({ id, nick, role });
  weekData.updatedAt = Date.now();

  logAction("addPerson", { id, nick, role });
  saveWeek();
  document.getElementById("nickname").value = "";
}

/* =========================
   SAVE / CLEAR
========================= */
async function saveWeek(){
  if(!currentWeekKey) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏.");
  if(!canEdit()) return alert("–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ.");

  try{
    await db.ref("activity/" + currentWeekKey).set(weekData);
    await loadWeeksList();
  }catch(e){
    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
  }
}

async function clearWeek(){
  if(!currentWeekKey) return;
  if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–µ–ª–∏?")) return;
  if(!canManageUsers() && currentRole < 7){
    return alert("–û—á–∏—Å—Ç–∫–∞ –Ω–µ–¥–µ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –°—Ç.–ê–¥–º–∏–Ω—É+.");
  }
  try{
    await db.ref("activity/" + currentWeekKey).remove();
    await db.ref("logs/" + currentWeekKey).remove();
    logAction("clearWeek", { weekKey: currentWeekKey });
  }catch(e){
    alert("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: " + e.message);
  }
}

/* =========================
   EXPORT (XLS)
========================= */
function exportToExcel(){
  let table = document.getElementById("mainTable").outerHTML;
  let blob = new Blob([table], {type:"application/vnd.ms-excel"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Activity_${currentWeekKey || "week"}.xls`;
  a.click();
}

/* =========================
   LOGGING
========================= */
function logAction(action, payload){
  if(!canEdit()) return;
  if(!currentWeekKey) return;

  const ref = db.ref("logs/" + currentWeekKey).push();
  ref.set({
    ts: Date.now(),
    uid: currentUser?.uid || null,
    nick: currentNick,
    action,
    payload: payload || null
  }).catch(()=>{});
}

/* =========================
   USERS MANAGEMENT (ROLE)
========================= */
function openUsersPanel(){
  if(!canManageUsers()) return alert("–ù—É–∂–µ–Ω –°—Ç.–ê–¥–º–∏–Ω+.");
  document.getElementById("usersModal").style.display = "block";
  refreshUsersList();
}
function closeUsersPanel(){
  document.getElementById("usersModal").style.display = "none";
}

async function refreshUsersList(){
  const tbody = document.getElementById("usersList");
  tbody.innerHTML = "";
  const snap = await db.ref("users").get();
  if(!snap.exists()) return;
  const users = snap.val();
  const rows = Object.entries(users).map(([uid, u])=>({uid, ...u}))
    .sort((a,b)=>(b.role||0)-(a.role||0));

  for(const u of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:10px; border-top:1px solid rgba(27,42,85,.5); font-family: ui-monospace, SFMono-Regular, Menlo, monospace;">${escapeHtml(u.uid)}</td>
      <td style="padding:10px; border-top:1px solid rgba(27,42,85,.5);">${escapeHtml(u.nickname || "")}</td>
      <td style="padding:10px; border-top:1px solid rgba(27,42,85,.5); text-align:center;">
        <span class="badge ${ROLE_BADGE_CLASS(u.role||0)}">${ROLE_NAMES[u.role||0] ?? (u.role||0)}</span>
      </td>`;
    tbody.appendChild(tr);
  }
}

async function setUserRole(){
  if(!canManageUsers()) return alert("–ù—É–∂–µ–Ω –°—Ç.–ê–¥–º–∏–Ω+.");
  const uid = document.getElementById("u_uid").value.trim();
  const nick = document.getElementById("u_nick").value.trim();
  const role = parseInt(document.getElementById("u_role").value,10);

  if(!uid) return alert("–í–≤–µ–¥–∏ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");

  try{
    await db.ref("users/" + uid).update({
      nickname: nick || null,
      role: role,
      updatedAt: Date.now()
    });
    logAction("setUserRole", { uid, role, nickname: nick || null });
    refreshUsersList();
    alert("–ì–æ—Ç–æ–≤–æ.");
  }catch(e){
    alert("–û—à–∏–±–∫–∞: " + e.message);
  }
}

/* =========================
   INITIAL EMPTY TABLE
========================= */
renderEmptyTable();
</script>
</body>
</html>
