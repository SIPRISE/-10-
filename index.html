<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LoliLand Staff Dashboard ‚Äî Clean</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#05050b; --bg1:#090a15; --panel: rgba(12,12,24,.78);
      --line: rgba(255,255,255,.12); --text:#f3f4f6; --muted:#aab0c0;
      --violet:#a855f7; --cyan:#22d3ee; --green:#22c55e; --amber:#f59e0b;
      --r22: 22px; --shadow: 0 18px 55px rgba(0,0,0,.55);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:20px; color:var(--text);
      background: radial-gradient(900px 550px at 15% -10%, rgba(168,85,247,.35), transparent 60%),
                  linear-gradient(180deg, rgba(5,5,11,.88), rgba(5,5,11,.95)),
                  url("https://wallpaperaccess.com/full/8351177.jpg");
      background-size: cover; background-attachment: fixed;
      font-family: Inter, system-ui, sans-serif;
    }
    .wrap{ max-width: 1450px; margin: 0 auto; position:relative; }
    .topbar{ display:flex; gap:16px; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px; }
    .brand{ flex: 1 1 420px; background: rgba(255,255,255,.04); border: 1px solid var(--line); border-radius: var(--r22); padding: 16px; backdrop-filter: blur(10px); }
    .brand h1 span{ background: linear-gradient(90deg, var(--violet), var(--cyan)); -webkit-background-clip:text; color:transparent; font-weight: 900; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px; background: rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.1); color: var(--muted); font-size: 12px; }
    .actions{ display:flex; gap:10px; }
    button{ cursor:pointer; border:0; border-radius: 14px; padding: 12px 16px; color: var(--text); font-weight: 800; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); transition: 0.2s; }
    .btn-main{ background: linear-gradient(180deg, var(--violet), var(--violet2)); }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; background: var(--panel); border: 1px solid var(--line); border-radius: var(--r22); padding: 14px; backdrop-filter: blur(10px); margin-bottom: 16px; }
    .group{ display:flex; flex-direction:column; gap:6px; flex: 1 1 200px; }
    input, select{ width:100%; background: rgba(0,0,0,.3); border: 1px solid var(--line); color: var(--text); padding: 12px; border-radius: 14px; outline:none; font-weight: 700; }
    .staff-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 14px; }
    .card{ background: rgba(255,255,255,.03); border: 1px solid var(--line); border-radius: 24px; backdrop-filter: blur(10px); overflow:hidden; }
    .card-inner{ padding: 16px; }
    .card-top{ display:flex; justify-content:space-between; align-items: flex-start; margin-bottom: 12px; }
    .nick{ font-size: 18px; font-weight: 900; margin-bottom: 4px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 800; background: rgba(0,0,0,0.3); border: 1px solid var(--line); }
    .role-dot{ width: 8px; height: 8px; border-radius: 50%; background: var(--violet); }
    .progress{ display:flex; align-items:center; gap:10px; margin-bottom: 12px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 14px; }
    .bar{ flex:1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow:hidden; }
    .bar i{ display:block; height:100%; background: linear-gradient(90deg, var(--green), var(--cyan)); transition: 0.3s; }
    .days{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom: 12px; }
    .day{ background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
    .dname{ font-size: 10px; font-weight: 900; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; }
    .mini{ text-align:center; padding: 6px; font-size: 14px; border-radius: 8px; }
    .stats{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-bottom: 12px; }
    .stat{ background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; }
    .sname{ font-size: 10px; font-weight: 800; color: var(--muted); margin-bottom: 4px; }
    .foot{ display:flex; justify-content:space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 14px; font-weight: 900; font-size: 12px; }
    .kpi{ color: var(--green); }
    .btn-del{ padding: 6px 10px; font-size: 10px; background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: #ff8a8a; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1><span>LoliLand</span> Staff</h1>
        <div class="pill">–ù–µ–¥–µ–ª—è: <b id="weekDisplay">...</b></div>
      </div>
      <div class="actions">
        <button onclick="openArchive()">üìÅ –ê—Ä—Ö–∏–≤</button>
        <button class="btn-main" onclick="createNewWeek()">üìÖ –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è</button>
      </div>
    </div>

    <div class="controls">
      <div class="group"><label>–ù–∏–∫</label><input type="text" id="newNick"></div>
      <div class="group"><label>–†–æ–ª—å</label>
        <select id="newRole">
          <option value="8">–ê–¥–º–∏–Ω</option><option value="7">–°—Ç.–ê–¥–º–∏–Ω</option>
          <option value="6">–ú–ª.–ê–¥–º–∏–Ω</option><option value="5">–°—Ç.–ú–æ–¥–µ—Ä</option>
          <option value="3">–ú–ª.–ú–æ–¥–µ—Ä</option><option value="1">–•–µ–ª–ø–µ—Ä</option>
        </select>
      </div>
      <button class="btn-main" onclick="addPerson()" style="margin-top:20px">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="staff-grid" id="staffGrid"></div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ROLE_NAMES = { 8:"–ê–¥–º–∏–Ω", 7:"–°—Ç.–ê–¥–º–∏–Ω", 6:"–ú–ª.–ê–¥–º–∏–Ω", 5:"–°—Ç.–ú–æ–¥–µ—Ä", 3:"–ú–ª.–ú–æ–¥–µ—Ä", 1:"–•–µ–ª–ø–µ—Ä" };
const DAY_NAMES = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
let currentWeekKey = "", weekData = null;

async function init() {
  const snap = await db.ref("activity").limitToLast(1).once("value");
  let lastKey = snap.exists() ? Object.keys(snap.val())[0] : new Date().toISOString().split('T')[0];
  loadWeek(lastKey);
}

function loadWeek(key) {
  if (currentWeekKey) db.ref("activity/" + currentWeekKey).off();
  currentWeekKey = key;
  document.getElementById("weekDisplay").innerText = key;
  db.ref("activity/" + key).on("value", snap => {
    weekData = snap.val() || { people: [], entries: {} };
    render();
  });
}

function render() {
  const grid = document.getElementById("staffGrid");
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–∫—É—Å, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç
  const activeId = document.activeElement.id;
  grid.innerHTML = "";

  (weekData.people || []).forEach(p => {
    let screensTotal = 0;
    let daysHtml = "";
    for(let i=0; i<7; i++){
      const val = weekData.entries?.[p.id]?.[i]?.online || 0;
      screensTotal += Number(val);
      daysHtml += `
        <div class="day">
          <div class="dname">${DAY_NAMES[i]}</div>
          <input type="number" class="mini" id="input-${p.id}-${i}" value="${val}"
            oninput="valChange('${p.id}', ${i}, 'online', this.value)">
        </div>`;
    }

    const e = weekData.entries?.[p.id]?.[99] || {};
    const pct = Math.min(100, Math.round(screensTotal / 70 * 100));

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-inner">
        <div class="card-top">
          <div>
            <div class="nick">${p.nick}</div>
            <div class="badge"><span class="role-dot"></span>${ROLE_NAMES[p.role]}</div>
          </div>
          <button class="btn-del" onclick="removePerson('${p.id}')">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div class="progress">
          <div class="bar"><i id="bar-${p.id}" style="width:${pct}%"></i></div>
          <div class="val" id="total-txt-${p.id}">${screensTotal} / 70</div>
        </div>
        <div class="days">${daysHtml}</div>
        <div class="stats">
          <div class="stat"><div class="sname">–ú—É—Ç—ã</div><input type="number" class="mini" value="${e.mutes||0}" oninput="valChange('${p.id}', 99, 'mutes', this.value)"></div>
          <div class="stat"><div class="sname">–ë–∞–Ω—ã</div><input type="number" class="mini" value="${e.bans||0}" oninput="valChange('${p.id}', 99, 'bans', this.value)"></div>
          <div class="stat"><div class="sname">–¢–∏–∫–µ—Ç—ã</div><input type="number" class="mini" value="${e.tickets||0}" oninput="valChange('${p.id}', 99, 'tickets', this.value)"></div>
        </div>
      </div>`;
    grid.appendChild(card);
  });
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if(activeId) {
    const el = document.getElementById(activeId);
    if(el) {
       el.focus();
       // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
       const val = el.value;
       el.value = '';
       el.value = val;
    }
  }
}

function valChange(pid, dayIdx, field, val) {
  const numVal = parseInt(val) || 0;
  db.ref(`activity/${currentWeekKey}/entries/${pid}/${dayIdx}/${field}`).set(numVal);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã "–Ω–∞ –ª–µ—Ç—É" –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ –≤—Å–µ–π —Å–µ—Ç–∫–∏
  if(field === 'online') {
    let newTotal = 0;
    for(let i=0; i<7; i++) {
        const v = (i === dayIdx) ? numVal : (weekData.entries?.[pid]?.[i]?.online || 0);
        newTotal += Number(v);
    }
    const bar = document.getElementById(`bar-${pid}`);
    const txt = document.getElementById(`total-txt-${pid}`);
    if(bar) bar.style.width = Math.min(100, Math.round(newTotal / 70 * 100)) + '%';
    if(txt) txt.innerText = newTotal + ' / 70';
  }
}

function addPerson() {
  const nick = document.getElementById("newNick").value.trim();
  const role = document.getElementById("newRole").value;
  if (!nick) return;
  const newPerson = { id: "p_" + Date.now(), nick, role };
  const people = weekData.people || [];
  people.push(newPerson);
  db.ref("activity/" + currentWeekKey + "/people").set(people);
  document.getElementById("newNick").value = "";
}

function removePerson(pid) {
  if (confirm("–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞?")) {
    const updatedPeople = weekData.people.filter(x => x.id !== pid);
    db.ref(`activity/${currentWeekKey}/people`).set(updatedPeople);
    db.ref(`activity/${currentWeekKey}/entries/${pid}`).remove();
  }
}

async function createNewWeek() {
  const nextDate = prompt("–î–∞—Ç–∞ (–ì–ì–ì–ì-–ú–ú-–î–î):", new Date().toISOString().split('T')[0]);
  if (!nextDate) return;
  const currentPeople = weekData.people || [];
  await db.ref("activity/" + nextDate).set({ weekStart: nextDate, people: currentPeople, entries: {} });
  loadWeek(nextDate);
}

async function openArchive() {
  const snap = await db.ref("activity").once("value");
  const keys = Object.keys(snap.val() || {}).sort().reverse();
  const choice = prompt("–ù–µ–¥–µ–ª–∏:\n" + keys.join("\n"));
  if (choice && keys.includes(choice)) loadWeek(choice);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
