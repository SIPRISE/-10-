let peopleCount = 0;
    const salaries = { 1:70, 2:90, 3:110, 4:115, 5:130, 6:180, 7:215, 8:180 };

    function autoSalary() {
        const role = document.getElementById("role").value;
        document.getElementById("salary").value = salaries[role];
    }

    function generateWeek() {
        const start = document.getElementById("weekStart").value;
        if (!start) return;
        const body = document.getElementById("bodyRows");
        body.innerHTML = "";
        const date = new Date(start);

        for (let i = 0; i < 7; i++) {
            const d = new Date(date);
            d.setDate(date.getDate() + i);
            const opt = { weekday: 'short', day: 'numeric', month: 'short' };
            const formatted = d.toLocaleDateString('ru-RU', opt);
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="sticky-col" style="color:var(--accent)">${formatted}</td>`;
            body.appendChild(tr);
        }

        ["üìä –û–Ω–ª–∞–π–Ω (—á)", "üö´ –ú—É—Ç—ã", "üî® –ë–∞–Ω—ã", "üì© –¢–∏–∫–µ—Ç—ã"].forEach(stat => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="sticky-col" style="font-style:italic; color:var(--text-muted)">${stat}</td>`;
            body.appendChild(tr);
        });
        
        peopleCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–µ–¥–µ–ª–∏
        document.querySelectorAll('.staff-col').forEach(el => el.remove());
    }

    function addPerson() {
        const nick = document.getElementById("nickname").value;
        const role = document.getElementById("role");
        const sal = document.getElementById("salary").value;
        if (!nick) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!");

        document.getElementById("roleRow").insertAdjacentHTML('beforeend', `<th class="staff-col"><span class="badge role-${role.value}">${role.selectedOptions[0].text}</span></th>`);
        document.getElementById("nickRow").insertAdjacentHTML('beforeend', `<th class="staff-col">${nick}</th>`);
        document.getElementById("salaryRow").insertAdjacentHTML('beforeend', `<th class="staff-col" style="color:var(--success)">${sal}</th>`);

        const rows = document.getElementById("bodyRows").children;
        for (let row of rows) {
            row.insertAdjacentHTML('beforeend', `<td class="staff-col"><input type="number" value="0" class="cell-input col-${peopleCount}" oninput="calculate()"></td>`);
        }

        document.getElementById("sumRow").insertAdjacentHTML('beforeend', `<td class="staff-col" id="sum-${peopleCount}">0</td>`);
        peopleCount++;
        document.getElementById("nickname").value = "";
    }

    function calculate() {
        for (let i = 0; i < peopleCount; i++) {
            let sum = 0;
            document.querySelectorAll(`.col-${i}`).forEach(inp => {
                sum += (parseInt(inp.value) || 0);
                // –í–∞–∂–Ω–æ: –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ innerHTML
                inp.setAttribute('value', inp.value); 
            });
            const cell = document.getElementById(`sum-${i}`);
            if (cell) cell.textContent = sum;
        }
    }

    function saveWeek() {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ù–µ–¥–µ–ª—è 1'):");
        if (!name) return;
        
        // –ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã value
        document.querySelectorAll('.cell-input').forEach(inp => inp.setAttribute('value', inp.value));

        const data = { 
            html: document.getElementById("mainTable").innerHTML, 
            count: peopleCount 
        };
        localStorage.setItem("week_" + name, JSON.stringify(data));
        localStorage.setItem("last_week", name);
        loadWeeksList();
        alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ!");
    }

    function loadWeeksList() {
        const select = document.getElementById("weekSelect");
        select.innerHTML = '<option value="">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</option>';
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("week_")) {
                const opt = document.createElement("option");
                opt.value = key;
                opt.textContent = key.replace("week_", "");
                select.appendChild(opt);
            }
        }
    }

    function loadWeek(specificKey = null) {
        const key = specificKey || document.getElementById("weekSelect").value;
        if (!key) return;
        const stored = JSON.parse(localStorage.getItem(key));
        if (stored) {
            document.getElementById("mainTable").innerHTML = stored.html;
            peopleCount = stored.count;
            rebindInputs();
        }
    }

    function rebindInputs() {
        document.querySelectorAll('.cell-input').forEach(inp => {
            inp.oninput = calculate;
        });
    }

    function clearData() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ —ç—Ç–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞?")) {
            localStorage.clear();
            location.reload();
        }
    }

    window.onload = () => {
        loadWeeksList();
        const last = localStorage.getItem("last_week");
        if (last) loadWeek("week_" + last);
    };

    autoSalary();
