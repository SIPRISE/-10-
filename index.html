<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Activity System ‚Äî LoliLand</title>

  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#060812; --bg2:#0a1026; --card:#0b122b; --border:#1b2a55; --text:#e6ecff; 
      --accent:#7c3aed; --accent2:#22d3ee; --success:#10b981; --warn:#facc15; --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:22px;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.22), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text); font-family: system-ui, -apple-system, sans-serif;
    }
    .wrap{max-width:100%; margin:0 auto;}
    .card{ background: rgba(11,18,43,.92); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); overflow:hidden; }
    .header{ padding:18px 20px; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(90deg, rgba(124,58,237,.1), rgba(34,211,238,.1)); border-bottom:1px solid var(--border); }
    .toolbar{ display:flex; flex-wrap:wrap; gap:12px; padding:16px 18px; background: rgba(6,8,18,.35); border-bottom:1px solid var(--border); align-items:flex-end; }
    .group{display:flex; flex-direction:column; gap:6px;}
    .group label{font-size:11px; font-weight:900; color: var(--accent2); text-transform:uppercase;}
    input, select{ min-height:40px; background: #0a1026; color: var(--text); border:1px solid var(--border); border-radius:10px; padding:10px; outline:none; }
    button{ cursor:pointer; border:none; border-radius:10px; padding:10px 14px; font-weight:900; transition: .1s; display:inline-flex; align-items:center; gap:8px; }
    .btn-primary{ background: var(--accent); color:white; }
    .btn-success{ background: var(--success); color:#052016; }
    .btn-danger{ background: var(--danger); color:white; }
    .btn-ghost{ background: rgba(230,236,255,.05); border:1px solid rgba(230,236,255,.1); color: var(--text); }
    .spacer{ margin-left:auto; }
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:collapse; min-width:1400px; }
    th, td{ border:1px solid var(--border); padding:10px; text-align:center; font-size:13px; }
    .sticky-col{ position:sticky; left:0; z-index:8; text-align:left; background: #060812; font-weight:900; min-width:200px; }
    .day-row{ background: rgba(239,68,68,0.03); }
    .activity-row{ background: rgba(230,236,255,0.03); }
    .total-row td{ background: #facc15 !important; color: #000 !important; font-weight: 1000; }
    .badge{ padding:4px 8px; border-radius:6px; font-size:11px; color:white; font-weight:bold; }
    .role-8{ background: #22c55e;} .role-7{ background: #3b82f6;} .role-6{ background: #ec4899;}
    .cell-input{ width:60px; background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:inherit; text-align:center; padding:5px; border-radius:6px; cursor: pointer; font-weight:bold; }
    
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:450px; background: #0b122b; border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .m-head{ padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .m-body{ padding:20px; display:flex; flex-direction:column; gap:15px; }
    .m-actions{ padding:15px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h2>–£—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî LoliLand</h2>
      <div id="weekPill" class="badge" style="background:var(--accent)">–ù–µ–¥–µ–ª—è: ‚Äî</div>
    </div>

    <div class="toolbar">
      <div class="group"><label>–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏</label><input type="date" id="weekStart" onchange="selectWeekFromDate()"></div>
      <div class="group"><label>–ù–∏–∫</label><input type="text" id="nickname" placeholder="–ù–∏–∫–Ω–µ–π–º"></div>
      <div class="group">
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <select id="role">
          <option value="8">–ê–¥–º–∏–Ω</option>
          <option value="7">–°—Ç.–ê–¥–º–∏–Ω</option>
          <option value="6">–ú–ª.–ê–¥–º–∏–Ω</option>
          <option value="5">–°—Ç.–ú–æ–¥–µ—Ä</option>
          <option value="3">–ú–ª.–ú–æ–¥–µ—Ä</option>
          <option value="1">–•–µ–ª–ø–µ—Ä</option>
        </select>
      </div>
      <button class="btn-primary" onclick="addPerson()">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="btn-success" onclick="saveWeek()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="spacer"></div>
      <button class="btn-danger" onclick="clearWeek()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="table-wrap">
      <table id="mainTable">
        <thead>
          <tr id="roleRow"><th class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</th></tr>
          <tr id="nickRow"><th class="sticky-col">–ù–∏–∫:</th></tr>
        </thead>
        <tbody id="bodyRows"></tbody>
        <tfoot>
          <tr class="total-row" id="sumTotalRow"><td class="sticky-col">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫—Ä–∏–Ω–æ–≤ (—Å—É–º–º–∞—Ä–Ω–æ)</td></tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="editBackdrop">
  <div class="modal">
    <div class="m-head"><b id="editTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b><button class="btn-ghost" onclick="closeEditor()">‚úï</button></div>
    <div class="m-body">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <div class="group"><label>–°–∫—Ä–∏–Ω—ã –¥–Ω—è</label><input type="number" id="editOnline"></div>
        <div class="group"><label>–ú—É—Ç—ã</label><input type="number" id="editMutes"></div>
        <div class="group"><label>–ë–∞–Ω—ã</label><input type="number" id="editBans"></div>
        <div class="group"><label>–¢–∏–∫–µ—Ç—ã</label><input type="number" id="editTickets"></div>
      </div>
    </div>
    <div class="m-actions">
      <button class="btn-ghost" onclick="closeEditor()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-success" onclick="confirmEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROLE_NAMES = { 8:"–ê–¥–º–∏–Ω", 7:"–°—Ç.–ê–¥–º–∏–Ω", 6:"–ú–ª.–ê–¥–º–∏–Ω", 5:"–°—Ç.–ú–æ–¥–µ—Ä", 3:"–ú–ª.–ú–æ–¥–µ—Ä", 1:"–•–µ–ª–ø–µ—Ä" };
let currentWeekKey = "", weekData = null;
let editPid = null, editDay = null;

function init() {
  const today = new Date();
  const monday = new Date(today.setDate(today.getDate() - (today.getDay() + 6) % 7));
  const k = monday.toISOString().split('T')[0];
  document.getElementById("weekStart").value = k;
  selectWeekFromDate();
}

function selectWeekFromDate() {
  currentWeekKey = document.getElementById("weekStart").value;
  document.getElementById("weekPill").innerText = "–ù–µ–¥–µ–ª—è: " + currentWeekKey;
  db.ref("activity/" + currentWeekKey).on("value", snap => {
    weekData = snap.exists() ? snap.val() : { weekStart: currentWeekKey, days: [], people: [], entries: {} };
    if(!weekData.days.length) {
       let d = new Date(currentWeekKey);
       for(let i=0; i<7; i++) {
         weekData.days.push(new Date(d).toISOString().split('T')[0]);
         d.setDate(d.getDate() + 1);
       }
    }
    renderTable();
  });
}

function renderTable() {
  const people = weekData.people || [];
  const days = weekData.days || [];
  
  document.getElementById("roleRow").innerHTML = `<td class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</td>` + 
    people.map(p => `<td><span class="badge role-${p.role}">${ROLE_NAMES[p.role]}</span></td>`).join('');
  document.getElementById("nickRow").innerHTML = `<td class="sticky-col">–ù–∏–∫:</td>` + 
    people.map(p => `<td><b>${p.nick}</b></td>`).join('');

  let html = "";
  // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ (–°–∫—Ä–∏–Ω—ã –ø–æ–º–æ—â–∏)
  days.forEach((d, idx) => {
    const dateFmt = d.split('-').reverse().slice(0,2).join('.');
    html += `<tr class="day-row"><td class="sticky-col">${dateFmt}</td>`;
    people.forEach(p => {
      const val = weekData.entries?.[p.id]?.[idx]?.online || 0;
      html += `<td><input class="cell-input" readonly value="${val}" onclick="openEditor('${p.id}', ${idx})"></td>`;
    });
    html += `</tr>`;
  });

  // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  const types = [{k:'bans', l:'–ë–∞–Ω—ã'}, {k:'mutes', l:'–ú—É—Ç—ã'}, {k:'tickets', l:'–¢–∏–∫–µ—Ç—ã'}];
  types.forEach(t => {
    html += `<tr class="activity-row"><td class="sticky-col">${t.l}</td>`;
    people.forEach(p => {
      let sum = 0;
      for(let i=0; i<7; i++) sum += (weekData.entries?.[p.id]?.[i]?.[t.k] || 0);
      html += `<td><input class="cell-input" readonly value="${sum}" onclick="openEditor('${p.id}', 0)"></td>`;
    });
    html += `</tr>`;
  });

  document.getElementById("bodyRows").innerHTML = html;
  renderTotalRow();
}

function renderTotalRow() {
  const people = weekData.people || [];
  let row = `<td class="sticky-col">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫—Ä–∏–Ω–æ–≤ (—Å—É–º–º–∞—Ä–Ω–æ)</td>`;
  people.forEach(p => {
    let total = 0;
    for(let i=0; i<7; i++) {
      const e = weekData.entries?.[p.id]?.[i] || {};
      total += (+e.online||0) + (+e.mutes||0) + (+e.bans||0) + (+e.tickets||0);
    }
    row += `<td>${total}</td>`;
  });
  document.getElementById("sumTotalRow").innerHTML = row;
}

function openEditor(pid, day) {
  editPid = pid; editDay = day;
  const p = weekData.people.find(x => x.id === pid);
  document.getElementById("editTitle").innerText = p.nick + " (–î–µ–Ω—å " + (day+1) + ")";
  const e = weekData.entries?.[pid]?.[day] || {online:0, mutes:0, bans:0, tickets:0};
  document.getElementById("editOnline").value = e.online;
  document.getElementById("editMutes").value = e.mutes;
  document.getElementById("editBans").value = e.bans;
  document.getElementById("editTickets").value = e.tickets;
  document.getElementById("editBackdrop").style.display = "flex";
}

function closeEditor() { document.getElementById("editBackdrop").style.display = "none"; }

function confirmEdit() {
  if(!weekData.entries[editPid]) weekData.entries[editPid] = {};
  weekData.entries[editPid][editDay] = {
    online: +document.getElementById("editOnline").value || 0,
    mutes: +document.getElementById("editMutes").value || 0,
    bans: +document.getElementById("editBans").value || 0,
    tickets: +document.getElementById("editTickets").value || 0
  };
  closeEditor();
  renderTable();
}

function addPerson() {
  const nick = document.getElementById("nickname").value;
  if(!nick) return;
  weekData.people.push({ id: "p_"+Date.now(), nick, role: document.getElementById("role").value });
  renderTable();
}

async function saveWeek() {
  await db.ref("activity/" + currentWeekKey).set(weekData);
}

async function clearWeek() {
  if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) {
    await db.ref("activity/" + currentWeekKey).remove();
    location.reload();
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
