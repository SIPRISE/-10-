<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LoliLand Staff Dashboard ‚Äî Elite</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg0:#05050b; --bg1:#090a15; --panel: rgba(12,12,24,.85);
      --line: rgba(255,255,255,.12); --text:#f3f4f6; --muted:#aab0c0;
      --violet:#a855f7; --cyan:#22d3ee; --green:#22c55e;
      --r22: 22px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 20px; color: var(--text);
      background: radial-gradient(900px 550px at 15% -10%, rgba(168,85,247,.35), transparent 60%),
                  linear-gradient(180deg, rgba(5,5,11,.88), rgba(5,5,11,.95)),
                  url("https://wallpaperaccess.com/full/8351177.jpg");
      background-size: cover; background-attachment: fixed;
      font-family: 'Inter', system-ui, sans-serif;
    }

    /* –ú–µ–Ω—é –≤—Ö–æ–¥–∞ */
    #auth-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5, 5, 11, 0.98); backdrop-filter: blur(25px);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: 0.6s;
    }
    .auth-card {
      background: rgba(255, 255, 255, 0.03); border: 1px solid var(--line);
      border-radius: 32px; padding: 40px; max-width: 450px; width: 90%; text-align: center;
    }
    .auth-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 30px; }
    .method-btn {
      background: rgba(255, 255, 255, 0.05); border: 1px solid var(--line);
      padding: 20px 10px; border-radius: 20px; cursor: pointer; transition: 0.3s;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .method-btn:hover { background: rgba(168, 85, 247, 0.15); border-color: var(--violet); }
    #pass-section { margin-top: 25px; display: none; flex-direction: column; gap: 12px; }
    .auth-input { background: rgba(0,0,0,0.4); border: 1px solid var(--line); padding: 14px; border-radius: 14px; color: #fff; text-align: center; outline: none; }
    .go-btn { background: var(--violet); color: white; padding: 14px; border-radius: 14px; font-weight: 800; cursor: pointer; border: none; }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç */
    .wrap { max-width: 1450px; margin: 0 auto; filter: blur(20px); transition: 1s; opacity: 0; }
    .wrap.active { filter: blur(0); opacity: 1; }

    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .brand h1 span { background: linear-gradient(90deg, var(--violet), var(--cyan)); -webkit-background-clip: text; color: transparent; font-weight: 900; }
    
    /* –°–µ–ª–µ–∫—Ç–æ—Ä –Ω–µ–¥–µ–ª—å */
    .week-selector-wrap { position: relative; display: inline-block; }
    .current-week-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--line);
      padding: 10px 20px; border-radius: 14px; color: #fff; font-weight: 700; cursor: pointer;
    }
    .week-dropdown {
      position: absolute; top: 120%; left: 0; background: #12121e;
      border: 1px solid var(--line); border-radius: 16px; min-width: 220px;
      display: none; z-index: 100;
    }
    .week-dropdown.show { display: block; }
    .week-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .week-item:hover { background: rgba(168, 85, 247, 0.15); }

    .admin-only { display: none !important; }
    body.editor-mode .admin-only { display: flex !important; }

    .controls { background: var(--panel); border: 1px solid var(--line); border-radius: 24px; padding: 16px; margin-bottom: 20px; gap: 12px; }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥ */
    .team-section { margin-bottom: 40px; }
    .team-title { font-size: 24px; font-weight: 900; margin-bottom: 20px; color: var(--cyan); border-left: 4px solid var(--violet); padding-left: 15px; }
    .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
    
    .card { background: rgba(255,255,255,0.03); border: 1px solid var(--line); border-radius: 26px; padding: 18px; backdrop-filter: blur(10px); }
    .card-top { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .badge { font-size: 11px; font-weight: 800; color: var(--violet); background: rgba(168,85,247,0.1); padding: 4px 10px; border-radius: 8px; }

    .bar-bg { height: 10px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
    .bar-fill { height: 100%; transition: 0.6s; }
    .total-info { display: flex; justify-content: space-between; font-size: 12px; font-weight: 800; margin-top: 6px; }

    .days { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .day { background: rgba(0,0,0,0.25); padding: 8px; border-radius: 12px; text-align: center; }
    .mini-input { width: 100%; border: none; background: transparent; color: #fff; text-align: center; font-size: 15px; font-weight: 700; outline: none; }

    .stats { display: flex; gap: 8px; }
    .stat { flex: 1; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; text-align: center; }
    .btn-del { background: rgba(239, 68, 68, 0.15); color: #ff8a8a; border: none; cursor: pointer; border-radius: 8px; padding: 5px 10px; }
  </style>
</head>
<body onclick="document.getElementById('weekDropdown').classList.remove('show')">

<div id="auth-overlay">
  <div class="auth-card">
    <h2 style="font-weight:900;">LoliLand Staff</h2>
    <div class="auth-methods">
      <div class="method-btn" onclick="loginAsReader()"><b>üìñ –ß–∏—Ç–∞—Ç–µ–ª—å</b></div>
      <div class="method-btn" onclick="showPassField()"><b>üõ† –†–µ–¥–∞–∫—Ç–æ—Ä</b></div>
    </div>
    <div id="pass-section">
      <input type="password" id="adminPass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
      <button class="go-btn" onclick="loginAsEditor()">–í–æ–π—Ç–∏</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <h1><span>LoliLand</span> Staff</h1>
      <div class="week-selector-wrap">
        <div class="current-week-btn" onclick="event.stopPropagation(); document.getElementById('weekDropdown').classList.toggle('show')">
          <span id="activeWeekLabel">–ó–∞–≥—Ä—É–∑–∫–∞...</span> ‚ñº
        </div>
        <div id="weekDropdown" class="week-dropdown"></div>
      </div>
    </div>
    <div class="actions admin-only">
      <button class="go-btn" onclick="createNewWeek()">üìÖ –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è</button>
    </div>
  </div>

  <div class="controls admin-only" style="display:flex; flex-wrap:wrap;">
    <input type="text" id="newNick" placeholder="–ù–∏–∫–Ω–µ–π–º" style="flex:2;">
    <select id="newRole" style="flex:1;">
      <option value="10">–°—Ç.–ê–¥–º–∏–Ω</option>
      <option value="8">–ê–¥–º–∏–Ω</option>
      <option value="6">–ú–ª.–ê–¥–º–∏–Ω</option>
      <option value="5">–°—Ç.–ú–æ–¥–µ—Ä</option>
      <option value="3">–ú–ª.–ú–æ–¥–µ—Ä</option>
      <option value="2">–°—Ç.–•–µ–ª–ø–µ—Ä</option>
      <option value="1">–•–µ–ª–ø–µ—Ä</option>
    </select>
    <select id="newTeam" style="flex:1;">
      <option value="9">–ö–æ–º–∞–Ω–¥–∞ 9</option>
      <option value="10">–ö–æ–º–∞–Ω–¥–∞ 10</option>
    </select>
    <button class="go-btn" onclick="addPerson()" style="flex:1;">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div class="team-section">
    <div class="team-title">–ö–æ–º–∞–Ω–¥–∞ 9</div>
    <div class="staff-grid" id="grid-team-9"></div>
  </div>

  <div class="team-section">
    <div class="team-title">–ö–æ–º–∞–Ω–¥–∞ 10</div>
    <div class="staff-grid" id="grid-team-10"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROLE_NAMES = { 10:"–°—Ç.–ê–¥–º–∏–Ω", 8:"–ê–¥–º–∏–Ω", 6:"–ú–ª.–ê–¥–º–∏–Ω", 5:"–°—Ç.–ú–æ–¥–µ—Ä", 3:"–ú–ª.–ú–æ–¥–µ—Ä", 2:"–°—Ç.–•–µ–ª–ø–µ—Ä", 1:"–•–µ–ª–ø–µ—Ä" };
let isEditor = false, currentWeekKey = "", weekData = null;

function loginAsReader() { isEditor = false; finishAuth(); }
function showPassField() { document.getElementById('pass-section').style.display = 'flex'; }
function loginAsEditor() {
  if (document.getElementById('adminPass').value === "123456789Aa") {
    isEditor = true; document.body.classList.add('editor-mode'); finishAuth();
  } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
}

async function finishAuth() {
  document.getElementById('auth-overlay').style.display = "none";
  document.querySelector('.wrap').classList.add('active');
  const snap = await db.ref("activity").limitToLast(1).once("value");
  loadWeek(snap.exists() ? Object.keys(snap.val())[0] : new Date().toISOString().split('T')[0]);
}

function loadWeek(key) {
  if (currentWeekKey) db.ref("activity/" + currentWeekKey).off();
  currentWeekKey = key;
  document.getElementById("activeWeekLabel").innerText = key;
  db.ref("activity/" + key).on("value", snap => {
    weekData = snap.val() || { people: [], entries: {} };
    render();
    updateWeekDropdown();
  });
}

function getProgColor(val) {
  if (val < 50) return "#ef4444";
  let hue = Math.min(120, ((val - 50) / 250) * 120); 
  return `hsl(${hue}, 75%, 50%)`;
}

function render() {
  const grids = { 9: document.getElementById("grid-team-9"), 10: document.getElementById("grid-team-10") };
  grids[9].innerHTML = ""; grids[10].innerHTML = "";

  const people = (weekData.people || []).sort((a,b) => b.role - a.role);

  people.forEach(p => {
    let total = 0, daysHtml = "";
    for(let i=0; i<7; i++){
      const val = weekData.entries?.[p.id]?.[i]?.online || 0;
      total += Number(val);
      daysHtml += `<div class="day"><div style="font-size:9px;">${["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"][i]}</div><input type="number" class="mini-input" value="${val}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', ${i}, 'online', this.value)"></div>`;
    }
    const e = weekData.entries?.[p.id]?.[99] || {};
    const color = getProgColor(total);
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-top"><div><div style="font-weight:900;">${p.nick}</div><div class="badge">${ROLE_NAMES[p.role]}</div></div><button class="btn-del admin-only" onclick="removePerson('${p.id}')">–£–¥–∞–ª–∏—Ç—å</button></div>
      <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(100, (total/300)*100)}%; background:${color}"></div></div>
      <div class="total-info"><span>–û–ß–ö–ò</span><span style="color:${color}">${total}</span></div>
      <div class="days" style="margin-top:10px;">${daysHtml}</div>
      <div class="stats">
        <div class="stat"><div style="font-size:9px;">–ú—É—Ç—ã</div><input type="number" class="mini-input" value="${e.mutes||0}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', 99, 'mutes', this.value)"></div>
        <div class="stat"><div style="font-size:9px;">–ë–∞–Ω—ã</div><input type="number" class="mini-input" value="${e.bans||0}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', 99, 'bans', this.value)"></div>
        <div class="stat"><div style="font-size:9px;">–¢–∏–∫–µ—Ç—ã</div><input type="number" class="mini-input" value="${e.tickets||0}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', 99, 'tickets', this.value)"></div>
      </div>`;
    if (grids[p.team || 9]) grids[p.team || 9].appendChild(card);
  });
}

function valChange(pid, dayIdx, field, val) {
  if(isEditor) db.ref(`activity/${currentWeekKey}/entries/${pid}/${dayIdx}/${field}`).set(parseInt(val) || 0);
}

function addPerson() {
  const nick = document.getElementById("newNick").value.trim();
  const role = parseInt(document.getElementById("newRole").value);
  const team = parseInt(document.getElementById("newTeam").value);
  if (nick && isEditor) {
    const people = weekData.people || [];
    people.push({ id: "p_" + Date.now(), nick, role, team });
    db.ref("activity/" + currentWeekKey + "/people").set(people);
    document.getElementById("newNick").value = "";
  }
}

function removePerson(pid) {
  if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
    db.ref(`activity/${currentWeekKey}/people`).set(weekData.people.filter(x => x.id !== pid));
    db.ref(`activity/${currentWeekKey}/entries/${pid}`).remove();
  }
}

async function createNewWeek() {
  const next = prompt("–î–∞—Ç–∞ (–ì–ì–ì–ì-–ú–ú-–î–î):", new Date().toISOString().split('T')[0]);
  if (next && isEditor) {
    await db.ref("activity/" + next).set({ people: weekData.people || [], entries: {} });
    loadWeek(next);
  }
}

async function updateWeekDropdown() {
  const snap = await db.ref("activity").once("value");
  const keys = Object.keys(snap.val() || {}).sort().reverse();
  document.getElementById("weekDropdown").innerHTML = keys.map(k => `<div class="week-item" onclick="loadWeek('${k}')">${k}</div>`).join('');
}
</script>
</body>
</html>
