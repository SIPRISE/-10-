<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LoliLand Staff ‚Äî Elite Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%2357B33E'/%3E%3Crect x='3' y='3' width='3' height='3' fill='%23000'/%3E%3Crect x='10' y='3' width='3' height='3' fill='%23000'/%3E%3Crect x='6' y='6' width='4' height='3' fill='%23000'/%3E%3Crect x='5' y='9' width='2' height='4' fill='%23000'/%3E%3Crect x='9' y='9' width='2' height='4' fill='%23000'/%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <style>
    :root { --bg: #05050b; --line: rgba(255, 255, 255, 0.08); --violet: #a855f7; --cyan: #22d3ee; --text: #f3f4f6; --muted: #94a3b8; --bad: #ef4444; --gold: #facc15; --card-bg: rgba(15, 15, 30, 0.6); --green: #22c55e; }
    * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    body { margin: 0; padding: 20px; color: var(--text); background: var(--bg); font-family: 'Inter', sans-serif; min-height: 100vh; overflow-x: hidden; }
    .bg-wrap { position: fixed; inset: 0; z-index: -3; background: radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.15), transparent 45%), radial-gradient(circle at 90% 80%, rgba(34, 211, 238, 0.1), transparent 45%); }
    .bg-anim { position: fixed; inset: -50%; z-index: -4; background: conic-gradient(from 180deg, rgba(168,85,247,0.08), rgba(34,211,238,0.05), rgba(168,85,247,0.08)); animation: spin 20s linear infinite; filter: blur(80px); }
    @keyframes spin { to { transform: rotate(360deg); } }
    #particles { position: fixed; inset: 0; z-index: -2; pointer-events: none; opacity: 0.4; }
    #auth-overlay, .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 30000; backdrop-filter: blur(12px); background: rgba(5, 5, 11, 0.8); }
    .modal-overlay { opacity: 0; pointer-events: none; }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .modal-card { background: #0f0f1e; border: 1px solid var(--line); padding: 32px; border-radius: 32px; width: 95%; max-width: 440px; box-shadow: 0 30px 60px rgba(0,0,0,0.5); }
    .btn { padding: 14px; border-radius: 14px; border: none; font-weight: 900; cursor: pointer; font-size: 13px; text-transform: uppercase; width: 100%; margin-bottom: 10px; }
    .btn-primary { background: var(--violet); color: #fff; }
    .btn-secondary { background: rgba(255,255,255,0.05); color: var(--muted); }
    .btn-cyan { background: var(--cyan); color: #000; }
    .search-input { background: rgba(255,255,255,0.03); border: 1px solid var(--line); padding: 12px 18px; border-radius: 14px; color: #fff; outline: none; font-family: inherit; }
    
    select.search-input {
      background: rgba(255,255,255,0.03) !important;
      color: #fff !important;
      cursor: pointer;
    }

    select.search-input option {
      background: #0f0f1e;
      color: #fff;
    }

    select.search-input option:hover {
      background: #a855f7;
      color: #fff;
    }
    
    .wrap { max-width: 1440px; margin: 0 auto; display: none; padding-top: 20px; }
    .wrap.active { display: block; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
    .team-section { margin-bottom: 50px; }
    .team-title { font-size: 22px; font-weight: 900; color: var(--cyan); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .team-title span { font-size: 14px; color: var(--muted); font-weight: 600; }
    .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
    .card { background: var(--card-bg); border: 1px solid var(--line); border-radius: 24px; padding: 24px; position: relative; backdrop-filter: blur(10px); cursor: grab; user-select: none; }
    .card.dragging { opacity: 0.5; cursor: grabbing; border-color: var(--violet); }
    .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
    .avatar { width: 48px; height: 48px; border-radius: 14px; background: linear-gradient(135deg, #a855f7, #6366f1); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 20px; color: #fff; }
    .role-text { color: var(--muted); font-weight: 900; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; }
    .role-text:hover { color: var(--cyan); }
    .nick-text { font-size: 18px; color: #fff; font-weight: 900; }
    .stat-row { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 600; color: var(--muted); }
    .stat-row b { color: #fff; font-size: 15px; }
    .stat-input { width: 50px; background: none; border: none; color: #fff; text-align: right; font-weight: 900; outline: none; font-family: inherit; font-size: 15px; }
    .days-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; margin-top: 15px; }
    .day-box { display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 8px 4px; border-radius: 12px; }
    .day-box span { font-size: 10px; color: var(--muted); margin-bottom: 5px; font-weight: 900; }
    .day-input { width: 100%; text-align: center; background: none; border: none; color: #fff; font-weight: 900; outline: none; font-family: inherit; font-size: 14px; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; margin: -4px 0 15px 0; overflow: hidden; width: 100%; }
    .progress-fill { height: 100%; background: var(--bad); border-radius: 3px; }
    .premium-zone { margin-top: 15px; padding: 14px; border-radius: 14px; background: rgba(168, 85, 247, 0.08); border: 1px dashed rgba(168, 85, 247, 0.3); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ CSS, –µ—Å–ª–∏ –Ω–µ—Ç –∫–ª–∞—Å—Å–∞ editor-mode –Ω–∞ body */
    .admin-only, .stars-only { display: none !important; }
    body.editor-mode .admin-only, body.editor-mode .stars-only { display: inline-block !important; }
    body.editor-mode .premium-zone { display: flex !important; }
    
    /* –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–º–∏—é */
    body:not(.editor-mode) .premium-zone { display: flex !important; cursor: default !important; }

    .delete-btn { position: absolute; top: 20px; right: 20px; color: var(--bad); font-size: 9px; font-weight: 900; text-transform: uppercase; cursor: pointer; padding: 4px 8px; border-radius: 6px; background: rgba(239, 68, 68, 0.1); pointer-events: auto; }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏ */
    #editRoleModal .modal-card {
      min-width: 300px;
    }

    .role-select {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .role-btn {
      padding: 12px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
      font-weight: 900;
      font-size: 11px;
      transition: all 0.2s;
    }

    .role-btn:hover,
    .role-btn.active {
      border-color: var(--violet);
      background: rgba(168, 85, 247, 0.15);
      color: var(--violet);
    }

    /* –ß–µ–∫–±–æ–∫—Å –¥–ª—è –æ—Ç—ã–≥—Ä—ã—à–∞ */
    .checkbox-row {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      margin-bottom: 12px;
      gap: 10px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--violet);
    }

    .checkbox-row label {
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
      flex: 1;
    }

    .remember-check {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      margin-top: 15px;
    }

    .remember-check input {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--violet);
    }

    .success-msg {
      color: var(--green);
      font-weight: 900;
      font-size: 12px;
      text-align: center;
      margin-top: 10px;
      animation: fadeOut 3s forwards;
    }

    @keyframes fadeOut {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π */
    .stats-summary {
      background: rgba(168, 85, 247, 0.05);
      border: 1px solid rgba(168, 85, 247, 0.2);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .stat-card {
      text-align: center;
    }

    .stat-card-label {
      color: var(--muted);
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .stat-card-value {
      color: var(--cyan);
      font-size: 24px;
      font-weight: 900;
    }

    .team-stats {
      margin-bottom: 30px;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(168, 85, 247, 0.15);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 900;
      color: var(--violet);
      margin-bottom: 4px;
    }

    /* Hover —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ */
    .card:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.1);
    }

    .filters-panel {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: var(--muted);
      cursor: pointer;
      font-weight: 900;
      font-size: 11px;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: var(--violet);
      border-color: var(--violet);
      color: #fff;
    }

    .loading-skeleton {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      height: 20px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="bg-anim"></div><div class="bg-wrap"></div><canvas id="particles"></canvas>

  <div id="auth-overlay">
    <div class="modal-card" style="text-align:center;">
      <h1 style="margin:0; font-size:28px; font-weight:900;">LoliLand Staff</h1>
      <p style="color:var(--muted); margin-bottom:30px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞</p>
      <div id="auth-main">
        <button class="btn btn-primary" onclick="showPassInput()">üõ† –†–µ–¥–∞–∫—Ç–æ—Ä</button>
        <button class="btn btn-secondary" onclick="showTeamSelect()">üìñ –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
      </div>
      <div id="team-select" style="display:none;">
        <button class="btn btn-primary" onclick="login(false, 9)">–ö–æ–º–∞–Ω–¥–∞ 9</button>
        <button class="btn btn-cyan" onclick="login(false, 10)">–ö–æ–º–∞–Ω–¥–∞ 10</button>
        <button class="btn btn-secondary" onclick="resetAuth()">–ù–∞–∑–∞–¥</button>
      </div>
      <div id="pass-ui" style="display:none;">
        <input type="password" id="adm-pass" class="search-input" style="width:100%; margin-bottom:15px;" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        <div class="remember-check">
          <input type="checkbox" id="rememberPass">
          <label for="rememberPass">–ó–∞–ø–æ–º–Ω–∏—Ç—å</label>
        </div>
        <div id="success-msg"></div>
        <button class="btn btn-primary" onclick="login(true)">–í–æ–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="resetAuth()">–ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal-card">
      <h3 style="margin-top:0; color:#fff;">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
      <div style="display:flex; flex-direction:column; gap:12px;">
        <input type="text" id="newNick" class="search-input" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <select id="newTeam" class="search-input"><option value="9">–ö–æ–º–∞–Ω–¥–∞ 9</option><option value="10" selected>–ö–æ–º–∞–Ω–¥–∞ 10</option></select>
        <select id="newRole" class="search-input">
          <option value="80">–°—Ç.–ê–¥–º–∏–Ω</option><option value="70">–ê–¥–º–∏–Ω</option><option value="60">–ú–ª.–ê–¥–º–∏–Ω</option><option value="50">–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option><option value="40">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option><option value="30">–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option><option value="20">–°—Ç.–•–µ–ª–ø–µ—Ä</option><option value="10">–•–µ–ª–ø–µ—Ä</option>
        </select>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn btn-secondary" style="margin:0;" onclick="closeAdd()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" style="margin:0;" onclick="confirmAdd()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="starModal">
    <div class="modal-card">
      <h3 id="sm-title" style="margin-top:0; color:var(--gold); font-weight:900;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤–µ–∑–¥</h3>
      <div id="sm-body" style="color:#fff; font-size:14px; line-height:1.6; margin-top:20px;"></div>
      <button class="btn btn-secondary" style="margin-top:20px; margin-bottom:0;" onclick="closeStarModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div class="modal-overlay" id="editRoleModal">
    <div class="modal-card">
      <h3 id="editRoleTitle" style="margin-top:0; color:#fff;">–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å</h3>
      <div class="role-select" id="roleButtonsContainer" style="margin:20px 0;"></div>
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-secondary" style="margin:0;" onclick="closeEditRoleModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" style="margin:0;" onclick="confirmRoleChange()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="main-wrap">
    <div class="top-bar">
      <div>
        <h2 id="viewTitle" style="margin:0; font-weight:900;">Dashboard</h2>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <select id="weekSelect" class="search-input" style="padding: 8px 12px;" onchange="loadWeek(this.value)"></select>
          <button class="btn btn-secondary admin-only" style="width:auto; padding:0 15px; margin:0;" onclick="createNewWeek()">+ –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è</button>
          <button class="btn btn-secondary" style="width:auto; padding:0 15px; margin:0;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="text" id="search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É..." oninput="render()">
        <button class="btn btn-primary admin-only" style="width:auto; margin:0;" onclick="openAdd()">+ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã -->
    <div id="stats-container" class="team-stats" style="display:none;"></div>

    <div id="team-9-section" class="team-section">
      <div class="team-title">–ö–æ–º–∞–Ω–¥–∞ 9 <span id="cnt-9"></span></div>
      <div class="staff-grid" id="grid-9"></div>
    </div>
    <div id="team-10-section" class="team-section">
      <div class="team-title" style="color: var(--violet);">–ö–æ–º–∞–Ω–¥–∞ 10 <span id="cnt-10"></span></div>
      <div class="staff-grid" id="grid-10"></div>
    </div>
  </div>

<script>
const firebaseConfig = { apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg", databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com", projectId: "aktiv-d4d72" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let isEditor = false, activeTeam = 10, currentWeek = "", weekData = null, allWeeks = [];
const ROLES = { 80:"–°—Ç.–ê–¥–º–∏–Ω", 70:"–ê–¥–º–∏–Ω", 60:"–ú–ª.–ê–¥–º–∏–Ω", 50:"–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", 40:"–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", 30:"–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", 20:"–°—Ç.–•–µ–ª–ø–µ—Ä", 10:"–•–µ–ª–ø–µ—Ä" };
const ROLE_ORDER = [80, 70, 60, 50, 40, 30, 20, 10]; // –û—Ç –≤—ã—à–µ –∫ –Ω–∏–∂–µ
const DAYS = ["–ü–ù", "–í–¢", "–°–†", "–ß–¢", "–ü–¢", "–°–ë", "–í–°"];
const PASSWORD = '123456789Aa';

let draggedElement = null;
let draggedPersonId = null;
let draggedTeam = null;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
  const savedPass = localStorage.getItem('loliland_pass');
  if(savedPass === PASSWORD) {
    document.getElementById('rememberPass').checked = true;
  }
});

function showPassInput() { 
  document.getElementById('auth-main').style.display='none'; 
  document.getElementById('pass-ui').style.display='block';
  const savedPass = localStorage.getItem('loliland_pass');
  if(savedPass === PASSWORD) {
    document.getElementById('adm-pass').value = savedPass;
  }
}

function showTeamSelect() { document.getElementById('auth-main').style.display='none'; document.getElementById('team-select').style.display='block'; }
function resetAuth() { document.getElementById('auth-main').style.display='block'; document.getElementById('pass-ui').style.display='none'; document.getElementById('team-select').style.display='none'; }

function login(ed, team) {
  if(ed && document.getElementById('adm-pass').value !== PASSWORD) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
  
  if(ed && document.getElementById('rememberPass').checked) {
    localStorage.setItem('loliland_pass', PASSWORD);
    showSuccessMsg();
  } else if(!document.getElementById('rememberPass').checked) {
    localStorage.removeItem('loliland_pass');
  }
  
  isEditor = ed; if(!ed) activeTeam = team;
  if(ed) document.body.classList.add('editor-mode');
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('main-wrap').classList.add('active');
  document.getElementById('viewTitle').innerText = ed ? "–†–µ–∂–∏–º –†–µ–¥–∞–∫—Ç–æ—Ä–∞" : `–ü—Ä–æ—Å–º–æ—Ç—Ä: –ö–æ–º–∞–Ω–¥–∞ ${team}`;
  init();
}

function logout() {
  location.reload();
}

function showSuccessMsg() {
  const msgDiv = document.getElementById('success-msg');
  msgDiv.innerHTML = '‚úì –ü–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω';
  msgDiv.className = 'success-msg';
  setTimeout(() => { msgDiv.innerHTML = ''; }, 3000);
}

async function init() {
  const snap = await db.ref("activity").limitToLast(20).once("value");
  allWeeks = Object.keys(snap.val() || {}).sort().reverse();
  updateWeekDropdown();
  loadWeek(allWeeks[0] || new Date().toISOString().split('T')[0]);
}

function updateWeekDropdown() { document.getElementById('weekSelect').innerHTML = allWeeks.map(w => `<option value="${w}">${w}</option>`).join(''); }

async function createNewWeek() {
  const name = prompt("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É (–ì–ì–ì–ì-–ú–ú-–î–î):", new Date().toISOString().split('T')[0]);
  if(!name) return;
  if(!allWeeks.includes(name)) { allWeeks.unshift(name); updateWeekDropdown(); document.getElementById('weekSelect').value = name; loadWeek(name); }
}

function loadWeek(key) {
  currentWeek = key;
  db.ref("activity/" + key).on("value", async snap => {
    weekData = snap.val();
    if(!weekData || !weekData.people || weekData.people.length === 0) {
      if(isEditor) {
        const prevWeekKey = allWeeks.find(w => w !== currentWeek);
        if(prevWeekKey) {
          const prevSnap = await db.ref(`activity/${prevWeekKey}/people`).once("value");
          if(prevSnap.val() && confirm(`–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤ –∏–∑ ${prevWeekKey}?`)) {
            await db.ref(`activity/${currentWeek}/people`).set(prevSnap.val());
            return;
          }
        }
      }
      weekData = { people: [], entries: {} };
    }
    render();
  });
}

function openStarModal(nick, scrStars, pen, penStars, tick, tickStars, playdays, playdaysStars, total) {
  document.getElementById('sm-title').innerText = `–ü—Ä–µ–º–∏—è: ${nick}`;
  document.getElementById('sm-body').innerHTML = `
    <div style="display:flex; justify-content:space-between; margin-bottom:12px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;"><span>–°–∫—Ä–∏–Ω—ã:</span> <b style="color:var(--cyan)">+${scrStars} ‚≠ê</b></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:12px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;"><span>–ú—É—Ç—ã/–ë–∞–Ω—ã (${pen}):</span> <b style="color:var(--bad)">+${penStars} ‚≠ê</b></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:12px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;"><span>–¢–∏–∫–µ—Ç—ã (${tick}):</span> <b style="color:var(--violet)">+${tickStars} ‚≠ê</b></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:12px; background:rgba(255,255,255,0.03); padding:10px; border-radius:10px;"><span>–û—Ç—ã–≥—Ä—ã—à 5 –¥–Ω–µ–π:</span> <b style="color:var(--violet)">+${playdaysStars} ‚≠ê</b></div>
    <hr style="border-color:var(--line); margin:20px 0;"><div style="display:flex; justify-content:space-between; font-size:20px; font-weight:900;"><span>–ò—Ç–æ–≥:</span> <b style="color:var(--gold)">${total} ‚≠ê</b></div>
  `;
  document.getElementById('starModal').classList.add('active');
}
function closeStarModal() { document.getElementById('starModal').classList.remove('active'); }

let editingRoleId = null, selectedRole = null;

function openEditRoleModal(personId, currentRole) {
  if(!isEditor) return;
  editingRoleId = personId;
  const person = (weekData.people || []).find(p => p.id === personId);
  if(!person) return;
  
  document.getElementById('editRoleTitle').innerText = `–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å: ${person.nick}`;
  selectedRole = person.role;
  
  const container = document.getElementById('roleButtonsContainer');
  container.innerHTML = '';
  
  ROLE_ORDER.forEach(level => {
    const name = ROLES[level];
    const btn = document.createElement('button');
    btn.className = 'role-btn' + (level === person.role ? ' active' : '');
    btn.textContent = name;
    btn.onclick = () => {
      document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedRole = level;
    };
    container.appendChild(btn);
  });
  
  document.getElementById('editRoleModal').classList.add('active');
}

function closeEditRoleModal() {
  document.getElementById('editRoleModal').classList.remove('active');
  editingRoleId = null;
  selectedRole = null;
}

async function confirmRoleChange() {
  if(!editingRoleId || !selectedRole) return;
  const people = weekData.people || [];
  const person = people.find(p => p.id === editingRoleId);
  if(person) {
    person.role = selectedRole;
    await db.ref(`activity/${currentWeek}/people`).set(people);
  }
  closeEditRoleModal();
}

function setupDragListeners(card, personId, team) {
  if(!isEditor) return;

  card.addEventListener('dragstart', (e) => {
    draggedElement = card;
    draggedPersonId = personId;
    draggedTeam = team;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  card.addEventListener('dragend', (e) => {
    card.classList.remove('dragging');
    draggedElement = null;
  });
}

function setupDropZone(grid) {
  if(!isEditor) return;

  grid.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if(draggedElement && draggedElement !== e.target) {
      grid.style.opacity = '0.8';
    }
  });

  grid.addEventListener('dragleave', (e) => {
    if(e.target === grid) {
      grid.style.opacity = '1';
    }
  });

  grid.addEventListener('drop', async (e) => {
    e.preventDefault();
    grid.style.opacity = '1';
    
    if(!draggedPersonId) return;

    const newTeam = grid === document.getElementById('grid-9') ? 9 : 10;
    
    if(draggedTeam === newTeam) return;

    const people = weekData.people || [];
    const person = people.find(p => p.id === draggedPersonId);
    
    if(person) {
      person.team = newTeam;
      await db.ref(`activity/${currentWeek}/people`).set(people);
      draggedElement = null;
      draggedPersonId = null;
      draggedTeam = null;
    }
  });
}

function calculateTeamStats(teamArray) {
  let totalStars = 0, totalScreens = 0, memberCount = teamArray.length;

  teamArray.forEach(p => {
    let scrStars = 0;
    for(let i=0; i<7; i++) {
      let daily = Number(weekData.entries?.[p.id]?.[i]?.online || 0);
      totalScreens += daily;
      scrStars += daily >= 40 ? 3 : (daily >= 11 ? 2 : (daily >= 1 ? 1 : 0));
    }
    const e = weekData.entries?.[p.id]?.[99] || { mutes:0, bans:0, tickets:0, playdays:false };
    let pen = Number(e.mutes||0) + Number(e.bans||0), penStars = pen >= 15 ? 3 : (pen >= 6 ? 2 : (pen >= 1 ? 1 : 0));
    let tick = Number(e.tickets||0), tickStars = tick >= 11 ? 3 : (tick >= 6 ? 2 : (tick >= 1 ? 1 : 0));
    let playdaysStars = e.playdays ? 5 : 0;
    totalStars += scrStars + penStars + tickStars + playdaysStars;
  });

  return { totalStars, totalScreens, memberCount };
}

function renderStats() {
  const people = weekData.people || [];
  const team9 = people.filter(p => p.team === 9);
  const team10 = people.filter(p => p.team === 10);
  
  const stats9 = calculateTeamStats(team9);
  const stats10 = calculateTeamStats(team10);
  const totalStats = { 
    stars: stats9.totalStars + stats10.totalStars,
    screens: stats9.totalScreens + stats10.totalScreens,
    members: stats9.memberCount + stats10.memberCount
  };

  const container = document.getElementById('stats-container');
  container.style.display = 'block';
  container.innerHTML = `
    <div class="stats-summary">
      <div class="stat-card">
        <div class="stat-card-label">–í—Å–µ–≥–æ –∑–≤–µ–∑–¥</div>
        <div class="stat-card-value">${totalStats.stars} ‚≠ê</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">–í—Å–µ–≥–æ —Å–∫—Ä–∏–Ω–æ–≤</div>
        <div class="stat-card-value">${totalStats.screens}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
        <div class="stat-card-value">${totalStats.members}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">–°—Ä. –∑–≤–µ–∑–¥/—á–µ–ª</div>
        <div class="stat-card-value">${totalStats.members > 0 ? (totalStats.stars / totalStats.members).toFixed(1) : 0}</div>
      </div>
    </div>
  `;
}

function render() {
  const grid9 = document.getElementById('grid-9'), grid10 = document.getElementById('grid-10');
  const sec9 = document.getElementById('team-9-section'), sec10 = document.getElementById('team-10-section');
  const q = document.getElementById('search').value.toLowerCase();
  grid9.innerHTML = ""; grid10.innerHTML = "";
  let c9 = 0, c10 = 0;
  sec9.style.display = (isEditor || activeTeam === 9) ? 'block' : 'none';
  sec10.style.display = (isEditor || activeTeam === 10) ? 'block' : 'none';

  const people = (weekData.people || []).filter(p => p.nick.toLowerCase().includes(q));
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—è–º (–æ—Ç –≤—ã—à–µ –∫ –Ω–∏–∂–µ)
  const team9 = people.filter(p => p.team === 9).sort((a, b) => ROLE_ORDER.indexOf(a.role) - ROLE_ORDER.indexOf(b.role));
  const team10 = people.filter(p => p.team === 10).sort((a, b) => ROLE_ORDER.indexOf(a.role) - ROLE_ORDER.indexOf(b.role));

  function renderTeam(teamArray, gridElement) {
    let count = 0;

    teamArray.forEach(p => {
      if (!isEditor && p.team !== activeTeam) return;

      let totalScr = 0, totalScreenStars = 0, daysHTML = "";
      for(let i=0; i<7; i++) {
        let dailyScreens = Number(weekData.entries?.[p.id]?.[i]?.online || 0);
        let dailyStars = dailyScreens >= 40 ? 3 : (dailyScreens >= 11 ? 2 : (dailyScreens >= 1 ? 1 : 0));
        totalScr += dailyScreens; totalScreenStars += dailyStars;
        daysHTML += `<div class="day-box"><span>${DAYS[i]}</span><input type="number" class="day-input" value="${dailyScreens}" ${!isEditor?'disabled':''} onchange="upd('${p.id}', ${i}, 'online', this.value)"><span class="stars-only" style="color:var(--gold); font-size:10px; margin-top:3px; font-weight:900;">${dailyStars} ‚≠ê</span></div>`;
      }
      const e = weekData.entries?.[p.id]?.[99] || { mutes:0, bans:0, tickets:0, playdays:false };
      let pen = Number(e.mutes||0) + Number(e.bans||0), penStars = pen >= 15 ? 3 : (pen >= 6 ? 2 : (pen >= 1 ? 1 : 0));
      let tick = Number(e.tickets||0), tickStars = tick >= 11 ? 3 : (tick >= 6 ? 2 : (tick >= 1 ? 1 : 0));
      let playdaysStars = e.playdays ? 5 : 0;
      let totalStars = totalScreenStars + penStars + tickStars + playdaysStars;

      const card = document.createElement('div'); 
      card.className = 'card';
      card.draggable = isEditor;
      card.innerHTML = `
        ${isEditor ? `<div class="delete-btn" onclick="removeMember('${p.id}')">–£–¥–∞–ª–∏—Ç—å</div>` : ''}
        <div class="card-header"><div class="avatar">‚ú¶</div><div><div class="role-text" ${isEditor ? `style="cursor:pointer;" onclick="openEditRoleModal('${p.id}', ${p.role})"` : ''}>${ROLES[p.role]||'STAFF'}</div><div class="nick-text">${p.nick}</div></div></div>
        <div class="stat-row" style="background:none; padding:0 0 5px 0; margin:0;"><span>–°–∫—Ä–∏–Ω—ã (–í—Å–µ–≥–æ)</span><b>${totalScr}</b></div>
        <div class="progress-bar"><div class="progress-fill" style="width: ${Math.min(totalScr, 100)}%; background:var(--cyan);"></div></div>
        <div class="days-grid">${daysHTML}</div>
        <div class="stat-row"><span>–ú—É—Ç—ã</span><input type="number" class="stat-input" value="${e.mutes||0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}', 99, 'mutes', this.value)"></div>
        <div class="stat-row"><span>–ë–∞–Ω—ã</span><input type="number" class="stat-input" value="${e.bans||0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}', 99, 'bans', this.value)"></div>
        <div class="stat-row"><span>–¢–∏–∫–µ—Ç—ã</span><input type="number" class="stat-input" value="${e.tickets||0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}', 99, 'tickets', this.value)"></div>
        ${isEditor ? `<div class="checkbox-row"><input type="checkbox" id="playdays-${p.id}" ${e.playdays ? 'checked' : ''} onchange="upd('${p.id}', 99, 'playdays', this.checked)"><label for="playdays-${p.id}">–û—Ç—ã–≥—Ä—ã—à 5 –¥–Ω–µ–π</label></div>` : ''}
        <div class="premium-zone" ${!isEditor ? 'onclick="openStarModal(\'' + p.nick + '\', ' + totalScreenStars + ', ' + pen + ', ' + penStars + ', ' + tick + ', ' + tickStars + ', ' + playdaysStars + ', ' + playdaysStars + ', ' + totalStars + ')"' : ''}>
          <span style="font-size:11px; font-weight:900; color:var(--violet); text-transform:uppercase;">–ü—Ä–µ–º–∏—è</span><b style="color:var(--gold); font-size:16px;">${totalStars} ‚≠ê</b>
        </div>`;
      
      setupDragListeners(card, p.id, p.team);
      gridElement.appendChild(card);
      count++;
    });

    return count;
  }

  c9 = renderTeam(team9, grid9);
  c10 = renderTeam(team10, grid10);

  setupDropZone(grid9);
  setupDropZone(grid10);

  document.getElementById('cnt-9').innerText = `(${c9} —á–µ–ª.)`; document.getElementById('cnt-10').innerText = `(${c10} —á–µ–ª.)`;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  renderStats();
}

function upd(id, day, field, val) { if(!isEditor && field !== 'playdays') return; db.ref(`activity/${currentWeek}/entries/${id}/${day}/${field}`).set(val === true || val === false ? val : (Number(val) || 0)); }
function openAdd() { document.getElementById('addModal').classList.add('active'); }
function closeAdd() { document.getElementById('addModal').classList.remove('active'); }
async function confirmAdd() {
  const nick = document.getElementById('newNick').value; if(!nick) return alert('–ù–∏–∫!');
  const p = { id: "u_"+Date.now(), nick, team: parseInt(document.getElementById('newTeam').value), role: parseInt(document.getElementById('newRole').value) };
  const list = weekData.people || []; list.push(p); await db.ref(`activity/${currentWeek}/people`).set(list);
  closeAdd(); document.getElementById('newNick').value = ""; 
}
async function removeMember(id) { if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return; const newList = (weekData.people || []).filter(x => x.id !== id); await db.ref(`activity/${currentWeek}/people`).set(newList); }

(function(){
  const c = document.getElementById('particles'), ctx = c.getContext('2d');
  let w, h, pts = []; function res() { w = c.width = innerWidth; h = c.height = innerHeight; }
  window.onresize = res; res();
  for(let i=0; i<40; i++) pts.push({x:Math.random()*w, y:Math.random()*h, r:Math.random()*1.5, v:Math.random()*0.3});
  function anim() { ctx.clearRect(0,0,w,h); ctx.fillStyle="#fff"; pts.forEach(p=>{ p.y-=p.v; if(p.y<0) p.y=h; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,7); ctx.fill(); }); requestAnimationFrame(anim); }
  anim();
})();
</script>
</body>
</html>
