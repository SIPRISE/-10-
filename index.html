<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LoliLand Staff ‚Äî Elite Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #05050b;
      --panel: rgba(15, 15, 30, 0.75);
      --line: rgba(255, 255, 255, 0.08);
      --violet: #a855f7;
      --cyan: #22d3ee;
      --text: #f3f4f6;
      --muted: #94a3b8;
    }

    * { box-sizing: border-box; transition: all 0.2s ease; }
    body {
      margin: 0; padding: 20px; color: var(--text); background: var(--bg);
      font-family: 'Inter', sans-serif;
      background-image: radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.1), transparent 40%);
    }

    /* –ú–µ–Ω—é –≤—Ö–æ–¥–∞ */
    #auth-overlay {
      position: fixed; inset: 0; background: var(--bg); z-index: 10000;
      display: flex; align-items: center; justify-content: center; backdrop-filter: blur(25px);
    }
    .auth-card {
      background: rgba(255,255,255,0.02); border: 1px solid var(--line);
      padding: 40px; border-radius: 40px; text-align: center; max-width: 400px; width: 90%;
    }
    .auth-btn {
      width: 100%; padding: 15px; margin-top: 10px; border-radius: 15px; border: none;
      font-weight: 800; cursor: pointer; font-size: 15px;
    }

    /* –í—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã –ø—Ä–∏ –≤—Ö–æ–¥–µ */
    #team-select-ui { display: none; margin-top: 20px; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é (–¥–ª—è –†–µ–¥–∞–∫—Ç–æ—Ä–æ–≤) */
    .view-switcher {
      display: flex; background: var(--panel); padding: 5px; border-radius: 15px; border: 1px solid var(--line);
    }
    .view-btn {
      padding: 8px 15px; border-radius: 10px; border: none; background: none; color: var(--muted);
      cursor: pointer; font-weight: 700; font-size: 12px;
    }
    .view-btn.active { background: var(--violet); color: #fff; }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .wrap { max-width: 1400px; margin: 0 auto; display: none; }
    .wrap.active { display: block; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
    
    .stats-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .stat-box { background: var(--panel); border: 1px solid var(--line); padding: 15px 20px; border-radius: 20px; border-left: 4px solid var(--violet); }
    .stat-val { font-size: 24px; font-weight: 900; display: block; }
    
    .team-section { margin-bottom: 50px; }
    .team-section.hidden { display: none; }
    .team-title { font-size: 28px; font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }

    .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(330px, 1fr)); gap: 20px; }
    .card { background: var(--panel); border: 1px solid var(--line); border-radius: 25px; padding: 20px; }
    .card:hover { border-color: var(--violet); transform: translateY(-5px); }
    
    .bar-bg { height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 15px 0 5px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 10px; }
    
    .days-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
    .day-box { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; text-align: center; }
    .day-box input { width: 100%; background: none; border: none; color: #fff; text-align: center; font-weight: 800; outline: none; }
    
    .admin-only { display: none !important; }
    body.editor-mode .admin-only { display: flex !important; }

    .search-input { background: var(--panel); border: 1px solid var(--line); padding: 12px 20px; border-radius: 15px; color: #fff; outline: none; }
    .search-input:focus { border-color: var(--violet); }
  </style>
</head>
<body onclick="hideDropdowns()">

<div id="auth-overlay">
  <div class="auth-card" id="auth-step-1">
    <h1 style="margin:0 0 10px; font-weight:900;">LoliLand Staff</h1>
    <button class="auth-btn" style="background: rgba(255,255,255,0.05); color: #fff;" onclick="prepareReader()">üìñ –ß–∏—Ç–∞—Ç–µ–ª—å</button>
    <button class="auth-btn" style="background: var(--violet); color: #fff;" onclick="showPassUI()">üõ† –†–µ–¥–∞–∫—Ç–æ—Ä</button>
    
    <div id="pass-ui" style="display:none; margin-top:20px;">
      <input type="password" id="admin-pass" class="search-input" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;">
      <button class="auth-btn" style="background: var(--violet); color: #fff;" onclick="login(true)">–í–æ–π—Ç–∏</button>
    </div>

    <div id="team-select-ui">
      <p style="color:var(--muted); font-size:14px;">–ö–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å?</p>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button class="auth-btn" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="login(false, 9)">–ö–æ–º–∞–Ω–¥–∞ 9</button>
        <button class="auth-btn" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="login(false, 10)">–ö–æ–º–∞–Ω–¥–∞ 10</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap" id="main-wrap">
  <div class="top-bar">
    <div>
      <h2 style="margin:0; font-weight:900;">Elite Dashboard</h2>
      <select id="weekSelect" class="search-input" style="margin-top:10px;" onchange="loadWeek(this.value)"></select>
    </div>
    
    <div style="display:flex; gap:15px; align-items:center;">
      <input type="text" id="searchField" class="search-input" placeholder="–ü–æ–∏—Å–∫ –Ω–∏–∫–∞..." oninput="render()">
      
      <div class="view-switcher admin-only" id="editor-view-controls">
        <button class="view-btn active" onclick="setFilter('all', this)">–í—Å–µ</button>
        <button class="view-btn" onclick="setFilter(9, this)">–ö9</button>
        <button class="view-btn" onclick="setFilter(10, this)">–ö10</button>
      </div>
      
      <button class="auth-btn admin-only" style="margin:0; padding:10px 20px; background:var(--violet); color:#fff;" onclick="createNewWeek()">+ –ù–µ–¥–µ–ª—è</button>
    </div>
  </div>

  <div class="stats-header">
    <div class="stat-box"><span style="color:var(--muted); font-size:11px;">–û–ë–©–ò–ô –û–ù–õ–ê–ô–ù</span><span class="stat-val" id="total-pts">0</span></div>
    <div class="stat-box"><span style="color:var(--muted); font-size:11px;">–ì–ï–†–û–ô –ù–ï–î–ï–õ–ò</span><span class="stat-val" id="top-player" style="color:var(--cyan)">‚Äî</span></div>
  </div>

  <div class="admin-only" style="background:var(--panel); padding:15px; border-radius:20px; margin-bottom:30px; gap:10px;">
    <input type="text" id="newNick" class="search-input" placeholder="–ù–∏–∫" style="flex:2;">
    <select id="newRole" class="search-input" style="flex:1;">
      <option value="10">–°—Ç.–ê–¥–º–∏–Ω</option><option value="8">–ê–¥–º–∏–Ω</option><option value="2">–°—Ç.–•–µ–ª–ø–µ—Ä</option><option value="1">–•–µ–ª–ø–µ—Ä</option>
    </select>
    <select id="newTeam" class="search-input" style="flex:1;">
      <option value="9">–ö–æ–º–∞–Ω–¥–∞ 9</option><option value="10">–ö–æ–º–∞–Ω–¥–∞ 10</option>
    </select>
    <button class="auth-btn" style="margin:0; flex:1; background:var(--violet); color:#fff;" onclick="addPerson()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div id="section-9" class="team-section">
    <div class="team-title">–ö–æ–º–∞–Ω–¥–∞ 9 <span style="font-size:14px; background:rgba(255,255,255,0.05); padding:4px 12px; border-radius:10px;" id="cnt-9">0</span></div>
    <div class="staff-grid" id="grid-9"></div>
  </div>

  <div id="section-10" class="team-section">
    <div class="team-title" style="color:var(--cyan)">–ö–æ–º–∞–Ω–¥–∞ 10 <span style="font-size:14px; background:rgba(255,255,255,0.05); padding:4px 12px; border-radius:10px; color:#fff;" id="cnt-10">0</span></div>
    <div class="staff-grid" id="grid-10"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROLE_NAMES = { 10:"–°—Ç.–ê–¥–º–∏–Ω", 8:"–ê–¥–º–∏–Ω", 2:"–°—Ç.–•–µ–ª–ø–µ—Ä", 1:"–•–µ–ª–ø–µ—Ä" };
let isEditor = false, currentWeekKey = "", weekData = null, teamFilter = 'all';

function prepareReader() { document.getElementById('team-select-ui').style.display = 'block'; }
function showPassUI() { document.getElementById('pass-ui').style.display = 'block'; }

function login(ed, team = 'all') {
  if(ed && document.getElementById('admin-pass').value !== '123456789Aa') return alert('–ü–∞—Ä–æ–ª—å!');
  isEditor = ed; teamFilter = team;
  if(ed) document.body.classList.add('editor-mode');
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('main-wrap').classList.add('active');
  start();
}

function setFilter(f, btn) {
  teamFilter = f;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

async function start() {
  const snap = await db.ref("activity").limitToLast(10).once("value");
  const weeks = Object.keys(snap.val() || {}).sort().reverse();
  document.getElementById('weekSelect').innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('');
  loadWeek(weeks[0]);
}

function loadWeek(key) {
  currentWeekKey = key;
  db.ref("activity/" + key).on("value", snap => {
    weekData = snap.val() || { people: [], entries: {} };
    render();
  });
}

function render() {
  const search = document.getElementById('searchField').value.toLowerCase();
  const grids = { 9: document.getElementById('grid-9'), 10: document.getElementById('grid-10') };
  grids[9].innerHTML = ""; grids[10].innerHTML = "";
  
  // –í–∏–¥–∏–º–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π
  document.getElementById('section-9').classList.toggle('hidden', teamFilter !== 'all' && teamFilter !== 9);
  document.getElementById('section-10').classList.toggle('hidden', teamFilter !== 'all' && teamFilter !== 10);

  let totalAll = 0, topP = { n: '‚Äî', v: 0 }, counts = { 9:0, 10:0 };
  const people = (weekData.people || []).sort((a,b) => b.role - a.role);

  people.forEach(p => {
    if(search && !p.nick.toLowerCase().includes(search)) return;
    
    let sum = 0;
    for(let i=0; i<7; i++) sum += Number(weekData.entries?.[p.id]?.[i]?.online || 0);
    totalAll += sum;
    if(sum > topP.v) topP = { n: p.nick, v: sum };

    const color = sum < 40 ? '#ef4444' : sum < 150 ? '#eab308' : '#22c55e';
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between;">
        <div><b style="font-size:18px;">${p.nick}</b><br><small style="color:var(--violet); font-weight:800;">${ROLE_NAMES[p.role]}</small></div>
        <button class="admin-only" onclick="removeP('${p.id}')" style="background:none; border:none; color:var(--muted); cursor:pointer;">‚úï</button>
      </div>
      <div class="bar-bg"><div class="bar-fill" style="width:${Math.min(100, sum/3)}%; background:${color}"></div></div>
      <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:800;"><span>–û–ß–ö–ò</span><span style="color:${color}">${sum}</span></div>
      <div class="days-grid">${[0,1,2,3,4,5,6].map(i => `<div class="day-box"><small style="font-size:8px; color:var(--muted)">${['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'][i]}</small><input type="number" value="${weekData.entries?.[p.id]?.[i]?.online || 0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}',${i},'online',this.value)"></div>`).join('')}</div>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
        <div class="day-box"><small style="font-size:8px;">–ú</small><input type="number" value="${weekData.entries?.[p.id]?.[99]?.mutes||0}" onchange="upd('${p.id}',99,'mutes',this.value)"></div>
        <div class="day-box"><small style="font-size:8px;">–ë</small><input type="number" value="${weekData.entries?.[p.id]?.[99]?.bans||0}" onchange="upd('${p.id}',99,'bans',this.value)"></div>
        <div class="day-box"><small style="font-size:8px;">–¢</small><input type="number" value="${weekData.entries?.[p.id]?.[99]?.tickets||0}" onchange="upd('${p.id}',99,'tickets',this.value)"></div>
      </div>
    `;
    const t = p.team || 9;
    if(grids[t]) { grids[t].appendChild(card); counts[t]++; }
  });

  document.getElementById('total-pts').innerText = totalAll;
  document.getElementById('top-player').innerText = topP.n;
  document.getElementById('cnt-9').innerText = counts[9];
  document.getElementById('cnt-10').innerText = counts[10];
}

function upd(id, d, f, v) { if(isEditor) db.ref(`activity/${currentWeekKey}/entries/${id}/${d}/${f}`).set(Number(v)||0); }

function addPerson() {
  const nick = document.getElementById('newNick').value;
  if(!nick) return;
  const p = { id: 'p'+Date.now(), nick, role: Number(document.getElementById('newRole').value), team: Number(document.getElementById('newTeam').value) };
  const list = weekData.people || [];
  list.push(p);
  db.ref(`activity/${currentWeekKey}/people`).set(list);
  document.getElementById('newNick').value = "";
}

function removeP(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.ref(`activity/${currentWeekKey}/people`).set(weekData.people.filter(x => x.id !== id)); }

async function createNewWeek() {
  const d = prompt("–î–∞—Ç–∞:", new Date().toISOString().split('T')[0]);
  if(d) { await db.ref(`activity/${d}`).set({ people: weekData.people || [], entries: {} }); location.reload(); }
}
</script>
</body>
</html>
