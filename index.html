<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LoliLand Staff ‚Äî Elite Dashboard</title>

  <!-- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Minecraft favicon (–±–µ–∑ —Ñ–∞–π–ª–æ–≤/—Å—Å—ã–ª–æ–∫, 100% —Ä–∞–±–æ—Ç–∞–µ—Ç) -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' fill='%2357B33E'/%3E%3Crect x='3' y='3' width='3' height='3' fill='%23000'/%3E%3Crect x='10' y='3' width='3' height='3' fill='%23000'/%3E%3Crect x='6' y='6' width='4' height='3' fill='%23000'/%3E%3Crect x='5' y='9' width='2' height='4' fill='%23000'/%3E%3Crect x='9' y='9' width='2' height='4' fill='%23000'/%3E%3C/svg%3E">
  <meta name="theme-color" content="#57B33E">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #05050b;
      --panel: rgba(15, 15, 30, 0.75);
      --line: rgba(255, 255, 255, 0.08);
      --violet: #a855f7;
      --cyan: #22d3ee;
      --text: #f3f4f6;
      --muted: #94a3b8;

      /* —Ö–∞–π–ø-–¥–æ–±–∞–≤–∫–∏ */
      --glow: 0 0 0 rgba(0,0,0,0);
      --panel2: rgba(20, 20, 40, 0.58);
      --good: #22c55e;
      --warn: #f59e0b;
      --bad:  #ef4444;
    }

    * { box-sizing: border-box; transition: all 0.18s ease; }
    html, body { height: 100%; }

    body {
      margin: 0; padding: 20px; color: var(--text); background: var(--bg);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }

    /* ‚úÖ –ñ–∏–≤–æ–π —Ñ–æ–Ω */
    .bg-wrap {
      position: fixed; inset: 0; z-index: -3;
      background:
        radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.18), transparent 45%),
        radial-gradient(circle at 85% 30%, rgba(34, 211, 238, 0.12), transparent 45%),
        radial-gradient(circle at 50% 85%, rgba(168, 85, 247, 0.10), transparent 55%);
      filter: saturate(1.15);
    }
    .bg-anim {
      position: fixed; inset: -30vh -30vw; z-index: -4;
      background: conic-gradient(from 180deg,
        rgba(168,85,247,0.12),
        rgba(34,211,238,0.10),
        rgba(168,85,247,0.12));
      animation: spin 14s linear infinite;
      opacity: .55;
      filter: blur(70px);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚úÖ –ß–∞—Å—Ç–∏—Ü—ã */
    #particles {
      position: fixed; inset: 0; z-index: -2;
      width: 100vw; height: 100vh;
      pointer-events: none;
      opacity: .55;
    }

    /* ‚úÖ –¢–æ—Å—Ç */
    .toast {
      position: fixed;
      bottom: 18px; left: 50%;
      transform: translateX(-50%) translateY(18px);
      background: rgba(15, 15, 30, 0.85);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px 14px;
      border-radius: 14px;
      color: #fff;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .2px;
      opacity: 0;
      z-index: 99999;
      backdrop-filter: blur(14px);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast i {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--good);
      box-shadow: 0 0 18px rgba(34,197,94,.55);
      display: inline-block;
    }

    /* --- –¢–í–û–ô –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô UI --- */
    #auth-overlay {
      position: fixed; inset: 0; background: rgba(5,5,11,0.82); z-index: 10000;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(25px);
    }
    .auth-card {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.10);
      padding: 40px; border-radius: 40px; text-align: center; max-width: 420px; width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }
    .auth-card:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(168,85,247,0.22), rgba(34,211,238,0.10), transparent 60%);
      filter: blur(22px);
      z-index: -1;
    }
    .auth-btn {
      width: 100%; padding: 15px; margin-top: 10px; border-radius: 15px; border: none;
      font-weight: 900; cursor: pointer; font-size: 15px;
    }
    .auth-btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

    #team-select-ui { display: none; margin-top: 20px; }

    .wrap { max-width: 1400px; margin: 0 auto; display: none; }
    .wrap.active { display: block; }

    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }

    .view-switcher {
      display: flex; background: rgba(255,255,255,0.03);
      padding: 5px; border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(12px);
    }
    .view-btn {
      padding: 8px 15px; border-radius: 10px; border: none; background: none;
      color: var(--muted); cursor: pointer; font-weight: 800;
    }
    .view-btn.active { background: var(--violet); color: #fff; box-shadow: 0 0 0 6px rgba(168,85,247,0.12); }

    .team-section { margin-bottom: 50px; }
    .team-section.hidden { display: none; }
    .team-title {
      font-size: 28px; font-weight: 900; margin-bottom: 14px;
      display: flex; align-items: center; gap: 15px;
    }

    /* ‚úÖ –¢–æ–ø-3 */
    .top3 {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .top3 .pill{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(10px);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .pill b{ color:#fff; font-weight: 900; }

    .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }

    /* ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∏: —Å—Ç–µ–∫–ª–æ + –Ω–µ–æ–Ω + 3D */
    .card {
      background: rgba(15, 15, 30, 0.64);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 32px;
      padding: 25px;
      box-shadow: 0 12px 42px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
      transform: translateY(6px);
      opacity: 0;
      animation: popIn .42s ease forwards;
      backdrop-filter: blur(14px);
      will-change: transform;
    }
    @keyframes popIn {
      to { transform: translateY(0); opacity: 1; }
    }

    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(168,85,247,0.18), rgba(34,211,238,0.10), transparent 60%);
      opacity: .7;
      filter: blur(18px);
      z-index: -1;
    }

    .card:hover {
      border-color: rgba(168, 85, 247, 0.45);
      box-shadow: 0 18px 65px rgba(168,85,247,0.10), 0 18px 65px rgba(34,211,238,0.06);
    }

    .card.tilt:hover { transform: rotateX(6deg) rotateY(-6deg) translateY(-2px); }

    /* –ê–≤–∞—Ç–∞—Ä–∫–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
    .card-header { display: flex; align-items: center; gap: 15px; margin-bottom: 14px; }
    .avatar-circle {
      width: 46px; height: 46px; border-radius: 14px;
      background: linear-gradient(135deg, var(--violet), var(--cyan));
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #fff;
      box-shadow: 0 10px 25px rgba(168, 85, 247, 0.18);
      position: relative;
      overflow: hidden;
    }
    .avatar-circle:after{
      content:"";
      position:absolute; inset:-12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.35), transparent 40%);
      opacity: .55;
      transform: rotate(20deg);
    }

    /* ‚úÖ —Å—Ç–∞—Ç—É—Å-—Ç–æ—á–∫–∞ */
    .status-dot{
      width: 9px; height: 9px; border-radius: 50%;
      margin-left: 8px;
      background: var(--muted);
      box-shadow: 0 0 0 4px rgba(148,163,184,0.12);
      display:inline-block;
      vertical-align: middle;
    }
    .status-dot.good{ background: var(--good); box-shadow: 0 0 0 4px rgba(34,197,94,0.12), 0 0 18px rgba(34,197,94,0.30); }
    .status-dot.warn{ background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,0.12), 0 0 18px rgba(245,158,11,0.25); }
    .status-dot.bad { background: var(--bad);  box-shadow: 0 0 0 4px rgba(239,68,68,0.12), 0 0 18px rgba(239,68,68,0.22); }

    .nick-box b { font-size: 18px; color: #fff; }
    .role-badge { font-size: 10px; font-weight: 900; color: var(--violet); text-transform: uppercase; letter-spacing: 1px; }

    /* ‚úÖ —É—Ä–æ–≤–µ–Ω—å-–ø–ª–∞—à–∫–∞ */
    .tier {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
      font-size: 11px;
      font-weight: 900;
      color: #fff;
      width: fit-content;
    }
    .tier .gem {
      width: 10px; height: 10px; border-radius: 3px;
      background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 0 18px rgba(255,255,255,0.10);
    }
    .tier.bronze{ box-shadow: 0 0 0 5px rgba(245,158,11,0.08); }
    .tier.silver{ box-shadow: 0 0 0 5px rgba(148,163,184,0.10); }
    .tier.gold  { box-shadow: 0 0 0 5px rgba(34,211,238,0.10); }

    /* ‚úÖ –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Ü–µ–ª–∏ */
    .goal {
      margin: 14px 0 18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .goal-row{
      display:flex; justify-content:space-between; align-items:center;
      font-size: 11px; font-weight: 900; color: var(--muted);
      letter-spacing: .5px;
      margin-bottom: 8px;
    }
    .bar{
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,0.35);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(168,85,247,0.9), rgba(34,211,238,0.9));
      box-shadow: 0 0 22px rgba(168,85,247,0.18);
    }

    .screens-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 16px 0; }
    .screen-day {
      background: rgba(0,0,0,0.28);
      padding: 10px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .screen-day:hover { transform: translateY(-1px); border-color: rgba(255,255,255,0.12); }
    .screen-day small { font-size: 9px; color: var(--muted); display: block; margin-bottom: 2px; }
    .screen-day b { font-size: 8px; color: var(--violet); display: block; margin-bottom: 5px; }
    .screen-input {
      width: 100%; background: none; border: none; color: #fff; text-align: center;
      font-size: 16px; font-weight: 900; outline: none;
    }

    .total-screens-row {
      background: linear-gradient(90deg, rgba(168, 85, 247, 0.12), transparent);
      padding: 12px 20px; border-radius: 15px; border: 1px solid rgba(168, 85, 247, 0.22);
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;
    }
    .total-screens-label { font-size: 12px; font-weight: 900; letter-spacing: 1px; }
    .total-screens-val { font-size: 18px; font-weight: 900; color: var(--violet); }

    .mod-stats-list { display: flex; flex-direction: column; gap: 8px; }
    .mod-item {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.03);
      padding: 12px 20px; border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .mod-item:hover { border-color: rgba(255,255,255,0.10); }
    .mod-item label { font-size: 11px; font-weight: 800; color: var(--muted); text-transform: uppercase; }
    .mod-input { width: 60px; background: none; border: none; color: #fff; text-align: right; font-size: 16px; font-weight: 900; outline: none; }

    .admin-only { display: none !important; }
    body.editor-mode .admin-only { display: flex !important; }

    .search-input {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 12px 20px;
      border-radius: 15px;
      color: #fff;
      outline: none;
      backdrop-filter: blur(12px);
    }
    .search-input:focus { border-color: rgba(168,85,247,0.45); box-shadow: 0 0 0 6px rgba(168,85,247,0.10); }

    @media (prefers-reduced-motion: reduce){
      .bg-anim, .card { animation: none !important; }
      *{ transition: none !important; }
    }
  </style>
</head>

<body>
  <!-- —Ñ–æ–Ω -->
  <div class="bg-anim"></div>
  <div class="bg-wrap"></div>
  <canvas id="particles"></canvas>

  <!-- —Ç–æ—Å—Ç -->
  <div class="toast" id="toast"><i></i><span id="toastText">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span></div>

  <div id="auth-overlay">
    <div class="auth-card">
      <h1 style="margin:0 0 10px; font-weight:900;">LoliLand Staff</h1>
      <button class="auth-btn" style="background: rgba(255,255,255,0.05); color: #fff;"
              onclick="document.getElementById('team-select-ui').style.display='block'">üìñ –ß–∏—Ç–∞—Ç–µ–ª—å</button>
      <button class="auth-btn" style="background: var(--violet); color: #fff;"
              onclick="document.getElementById('pass-ui').style.display='block'">üõ† –†–µ–¥–∞–∫—Ç–æ—Ä</button>

      <div id="pass-ui" style="display:none; margin-top:20px;">
        <input type="password" id="admin-pass" class="search-input" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;">
        <button class="auth-btn" style="background: var(--violet); color: #fff; margin-top:10px;" onclick="login(true)">–í–æ–π—Ç–∏</button>
      </div>

      <div id="team-select-ui">
        <p style="color:var(--muted); font-size:14px; margin-top:20px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</p>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <button class="auth-btn" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="login(false, 9)">–ö9</button>
          <button class="auth-btn" style="background:rgba(255,255,255,0.1); color:#fff;" onclick="login(false, 10)">–ö10</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap" id="main-wrap">
    <div class="top-bar">
      <div>
        <h2 style="margin:0; font-weight:900;">Staff Dashboard</h2>
        <select id="weekSelect" class="search-input" style="margin-top:10px;" onchange="loadWeek(this.value)"></select>

        <!-- ‚úÖ –¢–æ–ø-3 –Ω–µ–¥–µ–ª–∏ -->
        <div class="top3" id="top3"></div>
      </div>

      <div style="display:flex; gap:15px; align-items:center;">
        <input type="text" id="searchField" class="search-input" placeholder="–ü–æ–∏—Å–∫." oninput="render()">
        <div class="view-switcher admin-only">
          <button class="view-btn active" onclick="setFilter('all', this)">–í—Å–µ</button>
          <button class="view-btn" onclick="setFilter(9, this)">–ö9</button>
          <button class="view-btn" onclick="setFilter(10, this)">–ö10</button>
        </div>
        <button class="auth-btn admin-only" style="margin:0; padding:10px 20px; background:var(--violet); color:#fff; width:auto;" onclick="createNewWeek()">+ –ù–µ–¥–µ–ª—è</button>
      </div>
    </div>

    <div class="admin-only" style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.10); padding:20px; border-radius:25px; margin-bottom:40px; display:flex; gap:10px; backdrop-filter: blur(12px);">
      <input type="text" id="newNick" class="search-input" placeholder="–ù–∏–∫" style="flex:2;">
      <select id="newRole" class="search-input" style="flex:1;">
        <option value="80">–°—Ç.–ê–¥–º–∏–Ω</option>
        <option value="70">–ê–¥–º–∏–Ω</option>
        <option value="60">–ú–ª.–ê–¥–º–∏–Ω</option>
        <option value="50">–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
        <option value="40">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
        <option value="30">–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
        <option value="20">–°—Ç.–•–µ–ª–ø–µ—Ä</option>
        <option value="10">–•–µ–ª–ø–µ—Ä</option>
      </select>
      <select id="newTeam" class="search-input" style="flex:1;">
        <option value="9">–ö–æ–º–∞–Ω–¥–∞ 9</option><option value="10">–ö–æ–º–∞–Ω–¥–∞ 10</option>
      </select>
      <button class="auth-btn" style="margin:0; flex:1; background:var(--violet); color:#fff;" onclick="addPerson()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div id="section-9" class="team-section">
      <div class="team-title">–ö–æ–º–∞–Ω–¥–∞ 9 <span id="cnt-9" style="font-size:14px; color:var(--muted)"></span></div>
      <div class="staff-grid" id="grid-9"></div>
    </div>

    <div id="section-10" class="team-section">
      <div class="team-title" style="color:var(--cyan)">–ö–æ–º–∞–Ω–¥–∞ 10 <span id="cnt-10" style="font-size:14px; color:var(--muted)"></span></div>
      <div class="staff-grid" id="grid-10"></div>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// –ò–º–µ–Ω–∞ —Ä–æ–ª–µ–π
const ROLE_NAMES = {
  80:"–°—Ç.–ê–¥–º–∏–Ω", 70:"–ê–¥–º–∏–Ω", 60:"–ú–ª.–ê–¥–º–∏–Ω",
  50:"–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", 40:"–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", 30:"–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
  20:"–°—Ç.–•–µ–ª–ø–µ—Ä", 10:"–•–µ–ª–ø–µ—Ä"
};

let isEditor = false, currentWeekKey = "", weekData = null, teamFilter = 'all';

/* ‚úÖ —Ö–∞–π–ø-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–µ —Ç—Ä–æ–≥–∞—é—Ç –¥–∞–Ω–Ω—ã–µ) */
const WEEK_GOAL = 70; // —Ü–µ–ª—å —Å–∫—Ä–∏–Ω–æ–≤/–Ω–µ–¥–µ–ª—è ‚Äî –ø–æ–º–µ–Ω—è–π –∫–∞–∫ —Ö–æ—á–µ—à—å
let toastT = null;

function showToast(text="–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ") {
  const t = document.getElementById('toast');
  const tt = document.getElementById('toastText');
  tt.textContent = text;
  t.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(()=>t.classList.remove('show'), 1200);
}

function login(ed, team = 'all') {
  if(ed && document.getElementById('admin-pass').value !== '123456789Aa') return alert('–ü–∞—Ä–æ–ª—å!');
  isEditor = ed; teamFilter = team;
  if(ed) document.body.classList.add('editor-mode');
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('main-wrap').classList.add('active');
  start();
}

function setFilter(f, btn) {
  teamFilter = f;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

async function start() {
  const snap = await db.ref("activity").limitToLast(10).once("value");
  const weeks = Object.keys(snap.val() || {}).sort().reverse();
  document.getElementById('weekSelect').innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('');
  loadWeek(weeks[0]);
}

function loadWeek(key) {
  currentWeekKey = key;
  db.ref("activity/" + key).on("value", snap => {
    weekData = snap.val() || { people: [], entries: {} };
    render();
  });
}

/* ‚úÖ –≤—Å–ø–æ–º–æ–≥–∞–ª–∫–∏ –¥–ª—è —Ö–∞–π–ø–∞ */
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function tierFor(total){
  if(total >= 90) return {name:"GOLD", cls:"gold"};
  if(total >= 50) return {name:"SILVER", cls:"silver"};
  return {name:"BRONZE", cls:"bronze"};
}
function statusFor(total){
  if(total >= WEEK_GOAL) return "good";
  if(total >= Math.ceil(WEEK_GOAL * 0.55)) return "warn";
  return "bad";
}

function render() {
  const search = document.getElementById('searchField').value.toLowerCase();
  const grids = { 9: document.getElementById('grid-9'), 10: document.getElementById('grid-10') };
  grids[9].innerHTML = ""; grids[10].innerHTML = "";

  document.getElementById('section-9').classList.toggle('hidden', teamFilter !== 'all' && teamFilter !== 9);
  document.getElementById('section-10').classList.toggle('hidden', teamFilter !== 'all' && teamFilter !== 10);

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–æ–ª–∏ (–∫–∞–∫ –±—ã–ª–æ)
  const people = (weekData.people || []).sort((a,b) => b.role - a.role);

  let counts = { 9:0, 10:0 };

  // ‚úÖ —Ç–æ–ø-3 –Ω–µ–¥–µ–ª–∏ (–ø–æ totalScreens)
  const scored = [];
  people.forEach(p => {
    const days = [0,1,2,3,4,5,6];
    let total = 0;
    days.forEach(i => total += Number(weekData.entries?.[p.id]?.[i]?.online || 0));
    scored.push({ nick: p.nick, total });
  });
  scored.sort((a,b)=>b.total - a.total);
  const top3 = scored.slice(0,3).filter(x => x.nick);
  document.getElementById('top3').innerHTML = top3.length
    ? top3.map((x, idx)=>`<span class="pill">üèÜ ${idx+1} <b>${x.nick}</b> <span style="opacity:.9">‚Ä¢</span> ${x.total}</span>`).join('')
    : `<span class="pill">üèÜ –¢–æ–ø –Ω–µ–¥–µ–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –±—É–¥—É—Ç –¥–∞–Ω–Ω—ã–µ</span>`;

  people.forEach(p => {
    if(search && !p.nick.toLowerCase().includes(search)) return;

    let totalScreens = 0;
    const days = [0,1,2,3,4,5,6];
    days.forEach(i => totalScreens += Number(weekData.entries?.[p.id]?.[i]?.online || 0));
    const e = weekData.entries?.[p.id]?.[99] || { mutes:0, bans:0, tickets:0 };

    const tier = tierFor(totalScreens);
    const status = statusFor(totalScreens);
    const progress = clamp((totalScreens / WEEK_GOAL) * 100, 0, 100);

    const card = document.createElement('div');
    card.className = 'card tilt';
    card.innerHTML = `
      <div class="card-header">
        <div class="avatar-circle">‚ú¶</div>
        <div class="nick-box">
          <span class="role-badge">${ROLE_NAMES[p.role]}</span>
          <span class="status-dot ${status}" title="–°—Ç–∞—Ç—É—Å –ø–æ —Ü–µ–ª–∏ –Ω–µ–¥–µ–ª–∏"></span><br>
          <b>${p.nick}</b>
          <div class="tier ${tier.cls}"><span class="gem"></span> ${tier.name}</div>
        </div>
        <button class="admin-only" onclick="removeP('${p.id}')"
          style="position:absolute; top:18px; right:18px; background:none; border:none; color:var(--muted); cursor:pointer; font-size:20px;">√ó</button>
      </div>

      <div class="goal">
        <div class="goal-row">
          <span>–¶–µ–ª—å –Ω–µ–¥–µ–ª–∏: ${WEEK_GOAL}</span>
          <span style="color:#fff">${totalScreens}/${WEEK_GOAL}</span>
        </div>
        <div class="bar"><div style="width:${progress}%"></div></div>
      </div>

      <div class="screens-grid">
        ${['–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë','–í–°'].map((name, i) => `
          <div class="screen-day">
            <small>${name}</small>
            <b>–°–ö–†–ò–ù–´</b>
            <input type="number" class="screen-input"
              value="${weekData.entries?.[p.id]?.[i]?.online || 0}"
              ${!isEditor?'disabled':''}
              onchange="upd('${p.id}',${i},'online',this.value)">
          </div>
        `).join('')}
      </div>

      <div class="total-screens-row">
        <span class="total-screens-label">–ò–¢–û–ì–û –°–ö–†–ò–ù–û–í</span>
        <span class="total-screens-val">${totalScreens}</span>
      </div>

      <div class="mod-stats-list">
        <div class="mod-item"><label>–ú—É—Ç—ã</label><input type="number" class="mod-input" value="${e.mutes||0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}',99,'mutes',this.value)"></div>
        <div class="mod-item"><label>–ë–∞–Ω—ã</label><input type="number" class="mod-input" value="${e.bans||0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}',99,'bans',this.value)"></div>
        <div class="mod-item"><label>–¢–∏–∫–µ—Ç—ã</label><input type="number" class="mod-input" value="${e.tickets||0}" ${!isEditor?'disabled':''} onchange="upd('${p.id}',99,'tickets',this.value)"></div>
      </div>
    `;

    // –ª—ë–≥–∫–∏–π tilt –ø–æ –º—ã—à–∏ (–Ω–µ –ª–æ–º–∞–µ—Ç –º–æ–±–∏–ª—å–Ω—ã–µ/—Å—Ç–∞—Ä—ã–µ)
    card.addEventListener('mousemove', (ev) => {
      const r = card.getBoundingClientRect();
      const px = (ev.clientX - r.left) / r.width - 0.5;
      const py = (ev.clientY - r.top) / r.height - 0.5;
      card.style.transform = `rotateX(${(-py*7).toFixed(2)}deg) rotateY(${(px*7).toFixed(2)}deg) translateY(-2px)`;
    });
    card.addEventListener('mouseleave', () => {
      card.style.transform = '';
    });

    const t = p.team || 9;
    if(grids[t]) { grids[t].appendChild(card); counts[t]++; }
  });

  document.getElementById('cnt-9').innerText = `(${counts[9]} —á–µ–ª.)`;
  document.getElementById('cnt-10').innerText = `(${counts[10]} —á–µ–ª.)`;
}

function upd(id, d, f, v) {
  if(isEditor) {
    db.ref(`activity/${currentWeekKey}/entries/${id}/${d}/${f}`).set(Number(v)||0);
    showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  }
}

function addPerson() {
  const nick = document.getElementById('newNick').value;
  if(!nick) return;
  const p = {
    id: 'p'+Date.now(),
    nick,
    role: Number(document.getElementById('newRole').value),
    team: Number(document.getElementById('newTeam').value)
  };
  const list = weekData.people || [];
  list.push(p);
  db.ref(`activity/${currentWeekKey}/people`).set(list);
  document.getElementById('newNick').value = "";
  showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ");
}

function removeP(id) {
  if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
    db.ref(`activity/${currentWeekKey}/people`).set(weekData.people.filter(x => x.id !== id));
    showToast("–£–¥–∞–ª–µ–Ω–æ");
  }
}

async function createNewWeek() {
  const d = prompt("–î–∞—Ç–∞ (–ì–ì–ì–ì-–ú–ú-–î–î):", new Date().toISOString().split('T')[0]);
  if(d) {
    await db.ref(`activity/${d}`).set({ people: weekData.people || [], entries: {} });
    location.reload();
  }
}

/* ‚úÖ –ß–∞—Å—Ç–∏—Ü—ã –Ω–∞ —Ñ–æ–Ω–µ */
(function particles(){
  const c = document.getElementById('particles');
  const ctx = c.getContext('2d');
  let w=0,h=0, DPR=Math.min(2, window.devicePixelRatio||1);
  let pts=[];
  const N = 70;

  function resize(){
    w = c.width  = Math.floor(innerWidth * DPR);
    h = c.height = Math.floor(innerHeight * DPR);
    c.style.width  = innerWidth+'px';
    c.style.height = innerHeight+'px';
    pts = Array.from({length:N}, ()=>({
      x: Math.random()*w, y: Math.random()*h,
      r: (Math.random()*1.6+0.6)*DPR,
      vx: (Math.random()*0.6-0.3)*DPR,
      vy: (Math.random()*0.6-0.3)*DPR,
      a: Math.random()*0.45+0.15
    }));
  }
  addEventListener('resize', resize);
  resize();

  function tick(){
    ctx.clearRect(0,0,w,h);
    for(const p of pts){
      p.x += p.vx; p.y += p.vy;
      if(p.x<0) p.x=w; if(p.x>w) p.x=0;
      if(p.y<0) p.y=h; if(p.y>h) p.y=0;

      ctx.beginPath();
      ctx.globalAlpha = p.a;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = '#ffffff';
      ctx.fill();
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(tick);
  }
  tick();
})();
</script>
</body>
</html>
