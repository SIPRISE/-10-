<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Activity System ‚Äî LoliLand</title>

  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#060812;
      --bg2:#0a1026; --card:#0b122b; --card2:#0a1638;
      --border:#1b2a55; --text:#e6ecff; --accent:#7c3aed; --accent2:#22d3ee;
      --success:#10b981; --warn:#facc15; --danger:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --glow: 0 0 0 1px rgba(124,58,237,.25), 0 0 38px rgba(124,58,237,.25);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:22px;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.22), transparent 55%),
                  radial-gradient(1000px 700px at 85% 20%, rgba(34,211,238,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1600px; margin:0 auto;}
    .card{
      background: linear-gradient(180deg, rgba(11,18,43,.92), rgba(8,14,36,.92));
      border:1px solid rgba(27,42,85,.9); border-radius:18px;
      box-shadow: var(--shadow); overflow:hidden;
    }
    .header{
      padding:18px 20px; display:flex; align-items:center; justify-content:space-between; gap:16px;
      border-bottom:1px solid rgba(27,42,85,.8);
      background: linear-gradient(90deg, rgba(124,58,237,.16), rgba(34,211,238,.10));
    }
    .title h2{margin:0; font-size:18px; letter-spacing:.4px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
      background: rgba(124,58,237,.14); border:1px solid rgba(124,58,237,.30);
      border-radius:999px; box-shadow: var(--glow); font-size:12px;
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:12px; padding:16px 18px;
      border-bottom:1px solid rgba(27,42,85,.7); background: rgba(6,8,18,.35); align-items:flex-end;
    }
    .group{display:flex; flex-direction:column; gap:6px;}
    .group label{font-size:11px; font-weight:900; color: rgba(34,211,238,.95); text-transform:uppercase;}
    input, select{
      min-height:40px; background: rgba(10,16,38,.9); color: var(--text);
      border:1px solid rgba(27,42,85,.9); border-radius:10px; padding:10px 12px; outline:none;
    }
    button{
      cursor:pointer; border:none; border-radius:10px; padding:10px 14px;
      font-weight:900; transition: transform .08s ease; display:inline-flex; align-items:center; gap:8px;
    }
    button:hover{ filter: brightness(1.1); }
    .btn-primary{ background: linear-gradient(90deg, var(--accent), #a78bfa); color:white; }
    .btn-success{ background: linear-gradient(90deg, var(--success), #34d399); color:#052016; }
    .btn-danger{ background: linear-gradient(90deg, var(--danger), #fb7185); color:#2a040b; }
    .btn-ghost{ background: rgba(230,236,255,.06); border:1px solid rgba(230,236,255,.12); color: rgba(230,236,255,.9); }
    .spacer{ margin-left:auto; }
    .table-wrap{ overflow:auto; border-top:1px solid rgba(27,42,85,.65); }
    table{ width:100%; border-collapse:collapse; min-width:1200px; background: rgba(10,16,38,.55); }
    th, td{ border:1px solid rgba(27,42,85,.7); padding:12px; text-align:center; font-size:13px; }
    thead th{ position:sticky; top:0; z-index:7; background: rgba(11,18,43,.95); backdrop-filter: blur(10px); }
    .sticky-col{ position:sticky; left:0; z-index:8; text-align:left; font-weight:900; background: rgba(6,8,18,.92); }
    .day-divider{ background: rgba(124,58,237,.15) !important; color: var(--accent2); text-align: left; padding-left: 15px; font-weight: 1000; }
    .badge{ padding:5px 10px; border-radius:10px; font-size:11px; text-transform:uppercase; font-weight:1000; color:white; border:1px solid rgba(255,255,255,.12); }
    .role-8{ background: linear-gradient(90deg, #2563eb, #60a5fa);}
    .role-7{ background: linear-gradient(90deg, #10b981, #34d399);}
    .role-6{ background: linear-gradient(90deg, #a855f7, #c4b5fd);}
    .role-5{ background: linear-gradient(90deg, #ec4899, #f9a8d4);}
    .role-3{ background: linear-gradient(90deg, #38bdf8, #7dd3fc);}
    .role-2{ background: linear-gradient(90deg, #f97316, #fdba74);}
    .role-1{ background: linear-gradient(90deg, #14b8a6, #5eead4);}
    .cell-input{ width:72px; background: rgba(230,236,255,.06); border:1px solid rgba(230,236,255,.10); color:var(--text); text-align:center; padding:7px 8px; border-radius:9px; font-weight:900; cursor: pointer;}
    .sum-row td{ background: rgba(6,8,18,.92) !important; color: var(--warn); font-weight:1000; }
    .sum-sub td{ background: rgba(6,8,18,.80) !important; color: rgba(230,236,255,.85); font-weight:900; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:9999; padding:18px; }
    .modal{ width:min(520px,96vw); background: linear-gradient(180deg, rgba(11,18,43,.96), rgba(8,14,36,.96)); border:1px solid rgba(27,42,85,.9); border-radius:18px; box-shadow: var(--shadow); overflow:hidden; }
    .modal .m-head{ padding:14px 16px; border-bottom:1px solid rgba(27,42,85,.75); background: linear-gradient(90deg, rgba(124,58,237,.16), rgba(34,211,238,.10)); display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .modal .m-title{ font-weight:1000; letter-spacing:.3px; }
    .modal .m-body{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .modal .m-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .modal .m-field{ flex:1 1 120px; display:flex; flex-direction:column; gap:6px; }
    .modal .m-field label{ font-size:11px; font-weight:900; color: rgba(34,211,238,.95); text-transform:uppercase; }
    .modal .m-actions{ padding:14px 16px; border-top:1px solid rgba(27,42,85,.75); display:flex; gap:10px; justify-content:flex-end; background: rgba(6,8,18,.35); }
    .hint{ color:rgba(230,236,255,.65); font-size:12px; line-height:1.35; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="title"><h2>–£—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ—Å—Ç–∞–≤–∞ ‚Äî LoliLand</h2></div>
      <div class="pill" id="weekPill">–ù–µ–¥–µ–ª—è: ‚Äî</div>
    </div>

    <div class="toolbar">
      <div class="group"><label>–ù–µ–¥–µ–ª—è (–Ω–∞—á–∞–ª–æ)</label><input type="date" id="weekStart" onchange="selectWeekFromDate()"></div>
      <div class="group"><label>–ê—Ä—Ö–∏–≤ –Ω–µ–¥–µ–ª—å</label><select id="weekSelect" onchange="loadSelectedWeek()"><option value="">‚Äî</option></select></div>
      <div class="group"><label>–ù–∏–∫–Ω–µ–π–º</label><input type="text" id="nickname" placeholder="Nickname"></div>
      <div class="group">
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <select id="role">
          <option value="7">–°—Ç–∞—Ä—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="8">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="6">–ú–ª–∞–¥—à–∏–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
          <option value="5">–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
          <option value="3">–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
          <option value="2">–°—Ç–∞—Ä—à–∏–π –•–µ–ª–ø–µ—Ä</option>
          <option value="1">–•–µ–ª–ø–µ—Ä</option>
        </select>
      </div>
      <button class="btn-primary" id="btnAdd" onclick="addPerson()">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="btn-success" id="btnSave" onclick="saveWeek()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <div class="spacer"></div>
      <button class="btn-danger" id="btnClear" onclick="clearWeek()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="mainTable">
        <thead>
          <tr id="roleRow"><th class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th></tr>
          <tr id="nickRow"><th class="sticky-col">–ù–∏–∫–Ω–µ–π–º</th></tr>
        </thead>
        <tbody id="bodyRows"></tbody>
        <tfoot>
          <tr class="sum-row" id="sumScreensRow"><td class="sticky-col">–ò–¢–û–ì–û –°–ö–†–ò–ù–û–í (7 –¥–Ω–µ–π)</td></tr>
          <tr class="sum-sub" id="sumOnlineRow"><td class="sticky-col">Œ£ –û–Ω–ª–∞–π–Ω</td></tr>
          <tr class="sum-sub" id="sumMutesRow"><td class="sticky-col">Œ£ –ú—É—Ç—ã</td></tr>
          <tr class="sum-sub" id="sumBansRow"><td class="sticky-col">Œ£ –ë–∞–Ω—ã</td></tr>
          <tr class="sum-sub" id="sumTicketsRow"><td class="sticky-col">Œ£ –¢–∏–∫–µ—Ç—ã</td></tr>
          <tr class="sum-sub" id="sumRatingRow"><td class="sticky-col">–†–µ–π—Ç–∏–Ω–≥</td></tr>
        </tfoot>
      </table>
    </div>

    <div class="modal-backdrop" id="authBackdrop" style="display:flex">
      <div class="modal">
        <div class="m-head"><div class="m-title">–í—Ö–æ–¥</div><div class="pill" style="margin-left:auto">Activity System</div></div>
        <div class="m-body">
          <div class="group" style="width:100%"><label>–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫</label><input type="text" id="authNick" placeholder="Nickname" autocomplete="off"></div>
          <div class="hint">–ï—Å–ª–∏ –Ω–∏–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∏–∫–æ–º –∞–¥–º–∏–Ω–∞ ‚Äî —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –ò–Ω–∞—á–µ ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ.</div>
        </div>
        <div class="m-actions"><button class="btn-primary" id="authBtn">–í–æ–π—Ç–∏</button></div>
      </div>
    </div>

    <div class="modal-backdrop" id="editBackdrop">
      <div class="modal">
        <div class="m-head">
          <div class="m-title" id="editTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
          <button class="btn-ghost" id="editCloseBtn">‚úï</button>
        </div>
        <div class="m-body">
          <div class="m-row">
            <div class="m-field"><label>–û–Ω–ª–∞–π–Ω</label><input type="number" id="editOnline" min="0" step="1"></div>
            <div class="m-field"><label>–ú—É—Ç—ã</label><input type="number" id="editMutes" min="0" step="1"></div>
          </div>
          <div class="m-row">
            <div class="m-field"><label>–ë–∞–Ω—ã</label><input type="number" id="editBans" min="0" step="1"></div>
            <div class="m-field"><label>–¢–∏–∫–µ—Ç—ã</label><input type="number" id="editTickets" min="0" step="1"></div>
          </div>
          <div class="hint">–í–≤–æ–¥–∏ —á–∏—Å–ª–∞. –ü—É—Å—Ç–æ–µ = 0. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è.</div>
        </div>
        <div class="m-actions">
          <button class="btn-ghost" id="editCancelBtn">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn-success" id="editSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="note">
      <div style="color:rgba(230,236,255,.6)">–†–µ–π—Ç–∏–Ω–≥: –û–Ω–ª–∞–π–Ω√ó1 + –ú—É—Ç—ã√ó2 + –ë–∞–Ω—ã√ó3 + –¢–∏–∫–µ—Ç—ã√ó1.5</div>
      <button class="btn-ghost" onclick="exportToExcel()">üì• Export XLS</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROLE_NAMES = { 8:"–ê–¥–º–∏–Ω", 7:"–°—Ç.–ê–¥–º–∏–Ω", 6:"–ú–ª.–ê–¥–º–∏–Ω", 5:"–°—Ç.–ú–æ–¥–µ—Ä", 3:"–ú–ª.–ú–æ–¥–µ—Ä", 2:"–°—Ç.–•–µ–ª–ø–µ—Ä", 1:"–•–µ–ª–ø–µ—Ä" };
const WEIGHTS = { online: 1, mutes: 2, bans: 3, tickets: 1.5 };
const ADMIN_NICKS = ["SIPRISE", "playbodya_", "Nesquik_"];

let currentWeekKey = "", weekData = null, unsubWeek = null, currentUserNick = "", canEdit = false;
let editPid = null, editDay = null;

function ymd(date){
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function parseYmd(s){
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, (m||1)-1, d||1, 0,0,0,0);
}

function showAuth(){
  const backdrop = document.getElementById("authBackdrop");
  const input = document.getElementById("authNick");
  const btn = document.getElementById("authBtn");
  const doLogin = () => {
    const nick = (input.value || "").trim();
    if(!nick) return;
    currentUserNick = nick;
    canEdit = ADMIN_NICKS.map(n=>n.toLowerCase()).includes(nick.toLowerCase());
    applyAccessMode();
    backdrop.style.display = "none";
    init();
  };
  btn.onclick = doLogin;
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
}

function applyAccessMode(){
  const lock = !canEdit;
  ["btnAdd","btnSave","btnClear","nickname","role"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.disabled = lock;
  });
  const pill = document.getElementById("weekPill");
  if(pill) pill.innerText = pill.innerText.replace(" (READ)", "").replace(" (EDIT)", "") + (lock ? " (READ)" : " (EDIT)");
}

function init(){
  const today = new Date();
  const day = (today.getDay() + 6) % 7;
  const monday = new Date(today);
  monday.setDate(today.getDate() - day);
  const k = ymd(monday);
  document.getElementById("weekStart").value = k;
  selectWeekFromDate();
  loadWeeksList();
}

async function loadWeeksList(){
  db.ref("activity").on("value", snap => {
    const sel = document.getElementById("weekSelect");
    sel.innerHTML = `<option value="">‚Äî</option>`;
    if(!snap.exists()) return;
    Object.keys(snap.val()).sort().reverse().forEach(k => {
      const opt = document.createElement("option");
      opt.value = k; opt.textContent = k; sel.appendChild(opt);
    });
  });
}

function selectWeekFromDate(){
  const k = document.getElementById("weekStart").value;
  if(!k) return;
  currentWeekKey = k;
  document.getElementById("weekPill").innerText = "–ù–µ–¥–µ–ª—è: " + k;
  applyAccessMode();
  subscribeWeek(k);
}

function loadSelectedWeek(){
  const k = document.getElementById("weekSelect").value;
  if(k){ document.getElementById("weekStart").value = k; selectWeekFromDate(); }
}

function subscribeWeek(weekKey){
  if(unsubWeek) unsubWeek.off();
  unsubWeek = db.ref("activity/" + weekKey);
  unsubWeek.on("value", (snap)=>{
    weekData = snap.exists() ? snap.val() : buildDefaultWeek(weekKey);
    renderWeek();
  });
}

function buildDefaultWeek(weekKey){
  const days = [];
  const base = parseYmd(weekKey);
  for(let i=0;i<7;i++){
    const d = new Date(base);
    d.setDate(base.getDate()+i);
    days.push(ymd(d));
  }
  return { weekStart:weekKey, days, people:[], entries:{} };
}

function renderWeek(){
  if(!weekData) return;
  const people = weekData.people || [];
  const days = weekData.days || [];

  document.getElementById("roleRow").innerHTML = `<th class="sticky-col">–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>` + 
    people.map(p => `<th><span class="badge role-${p.role}">${ROLE_NAMES[p.role] || "‚Äî"}</span></th>`).join('');
  document.getElementById("nickRow").innerHTML = `<th class="sticky-col">–ù–∏–∫–Ω–µ–π–º</th>` + 
    people.map(p => `<th>${p.nick}</th>`).join('');

  let html = "";
  const types = [{k:'online',l:'–û–Ω–ª–∞–π–Ω'}, {k:'mutes',l:'–ú—É—Ç—ã'}, {k:'bans',l:'–ë–∞–Ω—ã'}, {k:'tickets',l:'–¢–∏–∫–µ—Ç—ã'}];

  for(let i=0; i<7; i++){
    const d = parseYmd(days[i]);
    const fmt = d.toLocaleDateString("ru-RU",{weekday:"short",day:"2-digit",month:"2-digit"});
    html += `<tr><td colspan="${people.length+1}" class="day-divider">${fmt}</td></tr>`;
    
    types.forEach(type => {
      html += `<tr><td class="sticky-col" style="padding-left:25px; font-size:11px; color:rgba(230,236,255,.5)">${type.l}</td>`;
      people.forEach(p => {
        const val = weekData.entries?.[p.id]?.[i]?.[type.k] || 0;
        html += `<td><input class="cell-input" type="text" readonly value="${val}" ${canEdit ? `onclick="openDayEditor('${p.id}',${i})"` : ''}></td>`;
      });
      html += `</tr>`;
    });
  }
  document.getElementById("bodyRows").innerHTML = html;
  renderTotals();
}

function renderTotals(){
  const people = weekData.people || [];
  const stats = ["–ò–¢–û–ì–û –°–ö–†–ò–ù–û–í","Œ£ –û–Ω–ª–∞–π–Ω","Œ£ –ú—É—Ç—ã","Œ£ –ë–∞–Ω—ã","Œ£ –¢–∏–∫–µ—Ç—ã","–†–µ–π—Ç–∏–Ω–≥"];
  const ids = ["sumScreensRow","sumOnlineRow","sumMutesRow","sumBansRow","sumTicketsRow","sumRatingRow"];

  ids.forEach((id, idx) => {
    let rowHtml = `<td class="sticky-col">${stats[idx]}</td>`;
    people.forEach(p => {
      let val = 0;
      const on = getSum(p.id,"online"), mu = getSum(p.id,"mutes"), ba = getSum(p.id,"bans"), ti = getSum(p.id,"tickets");
      if(idx===0) val = (on+mu+ba+ti);
      else if(idx===1) val = on;
      else if(idx===2) val = mu;
      else if(idx===3) val = ba;
      else if(idx===4) val = ti;
      else if(idx===5) val = Math.round((on*WEIGHTS.online + mu*WEIGHTS.mutes + ba*WEIGHTS.bans + ti*WEIGHTS.tickets)*10)/10;
      rowHtml += `<td>${val}</td>`;
    });
    document.getElementById(id).innerHTML = rowHtml;
  });
}

function getSum(pid, key){
  let s = 0;
  for(let i=0;i<7;i++) s += (+weekData.entries?.[pid]?.[i]?.[key]||0);
  return s;
}

function wireEditorModal(){
  const back = document.getElementById("editBackdrop");
  const saveBtn = document.getElementById("editSaveBtn");
  const close = ()=>{ back.style.display="none"; editPid=null; editDay=null; };

  document.getElementById("editCloseBtn").onclick = close;
  document.getElementById("editCancelBtn").onclick = close;
  
  saveBtn.onclick = () => {
    if(!canEdit || editPid===null) return close();
    if(!weekData.entries) weekData.entries = {};
    if(!weekData.entries[editPid]) weekData.entries[editPid] = {};
    
    weekData.entries[editPid][editDay] = {
      online: Math.max(0, parseInt(document.getElementById("editOnline").value)||0),
      mutes: Math.max(0, parseInt(document.getElementById("editMutes").value)||0),
      bans: Math.max(0, parseInt(document.getElementById("editBans").value)||0),
      tickets: Math.max(0, parseInt(document.getElementById("editTickets").value)||0)
    };
    close();
    saveWeek();
  };
}

function openDayEditor(pid, day){
  if(!canEdit) return;
  editPid = pid; editDay = day;
  const p = weekData.people.find(x=>x.id===pid);
  document.getElementById("editTitle").innerText = `${p?.nick} ‚Ä¢ ${weekData.days[day]}`;
  const e = weekData.entries?.[pid]?.[day] || {online:0,mutes:0,bans:0,tickets:0};
  document.getElementById("editOnline").value = e.online;
  document.getElementById("editMutes").value = e.mutes;
  document.getElementById("editBans").value = e.bans;
  document.getElementById("editTickets").value = e.tickets;
  document.getElementById("editBackdrop").style.display = "flex";
}

function addPerson(){
  if(!canEdit) return;
  const nick = document.getElementById("nickname").value.trim();
  const role = +document.getElementById("role").value;
  if(!nick) return;
  if(!weekData.people) weekData.people = [];
  weekData.people.push({ id:"p_"+Date.now(), nick, role });
  document.getElementById("nickname").value = "";
  saveWeek();
}

async function saveWeek(){ if(canEdit) await db.ref("activity/" + currentWeekKey).set(weekData); }
async function clearWeek(){ if(canEdit && confirm("–û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é?")) await db.ref("activity/" + currentWeekKey).remove(); }
function exportToExcel(){
  const blob = new Blob([document.getElementById("mainTable").outerHTML], {type:"application/vnd.ms-excel"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download="activity_loliland.xls";
  a.click();
}

document.addEventListener("DOMContentLoaded", () => { wireEditorModal(); showAuth(); });
</script>
</body>
</html>
