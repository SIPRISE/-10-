<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LoliLand Staff Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg0:#05050b; --bg1:#090a15; --panel: rgba(12,12,24,.78);
      --line: rgba(255,255,255,.12); --text:#f3f4f6; --muted:#aab0c0;
      --violet:#a855f7; --cyan:#22d3ee; --green:#22c55e;
      --r22: 22px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 20px; color: var(--text);
      background: radial-gradient(900px 550px at 15% -10%, rgba(168,85,247,.35), transparent 60%),
                  linear-gradient(180deg, rgba(5,5,11,.88), rgba(5,5,11,.95)),
                  url("https://wallpaperaccess.com/full/8351177.jpg");
      background-size: cover; background-attachment: fixed;
      font-family: 'Inter', system-ui, sans-serif;
      overflow-x: hidden;
    }

    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –º–µ–Ω—é –≤—Ö–æ–¥–∞ */
    #auth-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5, 5, 11, 0.98);
      backdrop-filter: blur(25px);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .auth-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--line);
      border-radius: 32px;
      padding: 40px;
      max-width: 450px; width: 90%;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0,0,0,0.6);
    }

    .auth-methods {
      display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 30px;
    }

    .method-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--line);
      padding: 20px 10px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }

    .method-btn:hover {
      background: rgba(168, 85, 247, 0.15);
      border-color: var(--violet);
      transform: translateY(-5px);
    }

    .method-btn b { font-size: 14px; display: block; }
    .method-btn small { color: var(--muted); font-size: 11px; }

    #pass-section {
      margin-top: 25px;
      display: none;
      flex-direction: column; gap: 12px;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

    .auth-input {
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--line);
      padding: 14px; border-radius: 14px;
      color: #fff; text-align: center; font-size: 16px; outline: none; transition: 0.3s;
    }
    .auth-input:focus { border-color: var(--violet); box-shadow: 0 0 15px rgba(168,85,247,0.3); }

    .go-btn {
      background: var(--violet);
      color: white; padding: 14px; border-radius: 14px;
      font-weight: 800; cursor: pointer; border: none;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .wrap { max-width: 1450px; margin: 0 auto; filter: blur(20px); transition: 1s; opacity: 0; }
    .wrap.active { filter: blur(0); opacity: 1; }

    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    .brand h1 span { background: linear-gradient(90deg, var(--violet), var(--cyan)); -webkit-background-clip: text; color: transparent; font-weight: 900; }
    
    .admin-only { display: none !important; }
    body.editor-mode .admin-only { display: flex !important; }

    .controls { background: var(--panel); border: 1px solid var(--line); border-radius: 24px; padding: 16px; backdrop-filter: blur(10px); margin-bottom: 20px; gap: 12px; }
    .group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
    
    input, select { background: rgba(0,0,0,0.3); border: 1px solid var(--line); color: var(--text); padding: 12px; border-radius: 14px; outline: none; font-weight: 600; }

    .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid var(--line); border-radius: 26px; padding: 18px; backdrop-filter: blur(10px); }
    
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .nick { font-size: 19px; font-weight: 900; letter-spacing: -0.5px; }
    .badge { font-size: 11px; font-weight: 800; color: var(--violet); background: rgba(168,85,247,0.1); padding: 4px 10px; border-radius: 8px; margin-top: 4px; display: inline-block; }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .bar-wrap { margin-bottom: 15px; }
    .bar-bg { height: 10px; background: rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; }
    .bar-fill { height: 100%; width: 0%; transition: 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .total-info { display: flex; justify-content: space-between; font-size: 12px; font-weight: 800; margin-top: 6px; }

    .days { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .day { background: rgba(0,0,0,0.25); padding: 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); text-align: center; }
    .dname { font-size: 9px; color: var(--muted); text-transform: uppercase; font-weight: 800; margin-bottom: 4px; }
    .mini-input { width: 100%; border: none; background: transparent; color: #fff; text-align: center; font-size: 15px; font-weight: 700; outline: none; }

    .stats { display: flex; gap: 8px; }
    .stat { flex: 1; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 12px; text-align: center; }
    .btn-del { background: rgba(239, 68, 68, 0.15); color: #ff8a8a; font-size: 10px; padding: 6px 10px; border-radius: 8px; border: none; cursor: pointer; }
    
    button:active { transform: scale(0.95); }
  </style>
</head>
<body>

<div id="auth-overlay">
  <div class="auth-card">
    <h2 style="margin:0; font-weight:900; font-size:24px;">LoliLand Staff</h2>
    <p style="color:var(--muted); font-size:14px; margin-top:8px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞</p>
    
    <div class="auth-methods">
      <div class="method-btn" onclick="loginAsReader()">
        <b>üìñ –ß–∏—Ç–∞—Ç–µ–ª—å</b>
        <small>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</small>
      </div>
      <div class="method-btn" onclick="showPassField()">
        <b>üõ† –†–µ–¥–∞–∫—Ç–æ—Ä</b>
        <small>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</small>
      </div>
    </div>

    <div id="pass-section">
      <input type="password" id="adminPass" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
      <button class="go-btn" onclick="loginAsEditor()">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <h1><span>LoliLand</span> Staff</h1>
      <div id="weekDisplay" style="font-size: 13px; color: var(--muted); font-weight: 600;"></div>
    </div>
    <div class="actions admin-only">
      <button onclick="openArchive()" style="padding:10px 16px; border-radius:12px; background:rgba(255,255,255,0.05); color:#fff; border:1px solid var(--line); cursor:pointer;">üìÅ –ê—Ä—Ö–∏–≤</button>
      <button class="go-btn" onclick="createNewWeek()" style="margin-left:8px;">üìÖ –ù–æ–≤–∞—è –Ω–µ–¥–µ–ª—è</button>
    </div>
  </div>

  <div class="controls admin-only">
    <div class="group"><label style="font-size:11px; font-weight:800; color:var(--muted); margin-left:5px;">–ù–ò–ö–ù–ï–ô–ú</label><input type="text" id="newNick" placeholder="–ò–≥—Ä–æ–∫..."></div>
    <div class="group">
      <label style="font-size:11px; font-weight:800; color:var(--muted); margin-left:5px;">–†–û–õ–¨</label>
      <select id="newRole">
        <option value="10">–°—Ç.–ê–¥–º–∏–Ω</option>
        <option value="8">–ê–¥–º–∏–Ω</option>
        <option value="6">–ú–ª.–ê–¥–º–∏–Ω</option>
        <option value="5">–°—Ç.–ú–æ–¥–µ—Ä</option>
        <option value="3">–ú–ª.–ú–æ–¥–µ—Ä</option>
        <option value="2">–°—Ç.–•–µ–ª–ø–µ—Ä</option>
        <option value="1">–•–µ–ª–ø–µ—Ä</option>
      </select>
    </div>
    <button class="go-btn" onclick="addPerson()" style="height:46px; margin-top:20px;">Ôºã –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <div class="staff-grid" id="staffGrid"></div>
</div>

<script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDugMq5xcJoVdLC9zPcAgDKCiAWpyYeyQg",
  databaseURL: "https://aktiv-d4d72-default-rtdb.firebaseio.com",
  projectId: "aktiv-d4d72",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ROLE_NAMES = { 10:"–°—Ç.–ê–¥–º–∏–Ω", 8:"–ê–¥–º–∏–Ω", 6:"–ú–ª.–ê–¥–º–∏–Ω", 5:"–°—Ç.–ú–æ–¥–µ—Ä", 3:"–ú–ª.–ú–æ–¥–µ—Ä", 2:"–°—Ç.–•–µ–ª–ø–µ—Ä", 1:"–•–µ–ª–ø–µ—Ä" };
let isEditor = false;
let currentWeekKey = "", weekData = null;

// –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function loginAsReader() {
  isEditor = false;
  finishAuth();
}

function showPassField() {
  document.getElementById('pass-section').style.display = 'flex';
}

function loginAsEditor() {
  const pass = document.getElementById('adminPass').value;
  if (pass === "123456789Aa") {
    isEditor = true;
    document.body.classList.add('editor-mode');
    finishAuth();
  } else {
    alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!");
  }
}

async function finishAuth() {
  document.getElementById('auth-overlay').style.opacity = "0";
  document.getElementById('auth-overlay').style.pointerEvents = "none";
  document.querySelector('.wrap').classList.add('active');
  
  const snap = await db.ref("activity").limitToLast(1).once("value");
  let lastKey = snap.exists() ? Object.keys(snap.val())[0] : new Date().toISOString().split('T')[0];
  loadWeek(lastKey);
}

function loadWeek(key) {
  if (currentWeekKey) db.ref("activity/" + currentWeekKey).off();
  currentWeekKey = key;
  document.getElementById("weekDisplay").innerText = "–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥: " + key;
  db.ref("activity/" + key).on("value", snap => {
    weekData = snap.val() || { people: [], entries: {} };
    render();
  });
}

// –†–∞—Å—á–µ—Ç —Ü–≤–µ—Ç–∞ (0 = –ö—Ä–∞—Å–Ω—ã–π, 120 = –ó–µ–ª–µ–Ω—ã–π)
function getProgColor(val) {
  if (val < 50) return "#ef4444";
  let hue = Math.min(120, ((val - 50) / 250) * 120); 
  return `hsl(${hue}, 75%, 50%)`;
}

function render() {
  const grid = document.getElementById("staffGrid");
  grid.innerHTML = "";

  const sorted = (weekData.people || []).sort((a,b) => b.role - a.role);

  sorted.forEach(p => {
    let total = 0;
    let daysHtml = "";
    for(let i=0; i<7; i++){
      const val = weekData.entries?.[p.id]?.[i]?.online || 0;
      total += Number(val);
      daysHtml += `
        <div class="day">
          <div class="dname">${["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"][i]}</div>
          <input type="number" class="mini-input" value="${val}" ${!isEditor?'disabled':''}
            onchange="valChange('${p.id}', ${i}, 'online', this.value)">
        </div>`;
    }

    const e = weekData.entries?.[p.id]?.[99] || {};
    const barW = Math.min(100, (total / 300) * 100);
    const color = getProgColor(total);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-top">
        <div>
          <div class="nick">${p.nick}</div>
          <div class="badge">${ROLE_NAMES[p.role]}</div>
        </div>
        <button class="btn-del admin-only" onclick="removePerson('${p.id}')">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <div class="bar-wrap">
        <div class="bar-bg"><div class="bar-fill" style="width:${barW}%; background:${color}; box-shadow: 0 0 10px ${color}44"></div></div>
        <div class="total-info">
          <span style="color:var(--muted)">–ü–†–û–ì–†–ï–°–°</span>
          <span style="color:${color}">${total} –û–ß–ö–û–í</span>
        </div>
      </div>
      <div class="days">${daysHtml}</div>
      <div class="stats">
        <div class="stat"><div class="dname">–ú—É—Ç—ã</div><input type="number" class="mini-input" value="${e.mutes||0}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', 99, 'mutes', this.value)"></div>
        <div class="stat"><div class="dname">–ë–∞–Ω—ã</div><input type="number" class="mini-input" value="${e.bans||0}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', 99, 'bans', this.value)"></div>
        <div class="stat"><div class="dname">–¢–∏–∫–µ—Ç—ã</div><input type="number" class="mini-input" value="${e.tickets||0}" ${!isEditor?'disabled':''} onchange="valChange('${p.id}', 99, 'tickets', this.value)"></div>
      </div>`;
    grid.appendChild(card);
  });
}

function valChange(pid, dayIdx, field, val) {
  if(!isEditor) return;
  db.ref(`activity/${currentWeekKey}/entries/${pid}/${dayIdx}/${field}`).set(parseInt(val) || 0);
}

function addPerson() {
  const nick = document.getElementById("newNick").value.trim();
  const role = parseInt(document.getElementById("newRole").value);
  if (!nick || !isEditor) return;
  const people = weekData.people || [];
  people.push({ id: "p_" + Date.now(), nick, role });
  db.ref("activity/" + currentWeekKey + "/people").set(people);
  document.getElementById("newNick").value = "";
}

function removePerson(pid) {
  if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞?")) {
    const updated = weekData.people.filter(x => x.id !== pid);
    db.ref(`activity/${currentWeekKey}/people`).set(updated);
    db.ref(`activity/${currentWeekKey}/entries/${pid}`).remove();
  }
}

async function createNewWeek() {
  const next = prompt("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É (–ì–ì–ì–ì-–ú–ú-–î–î):", new Date().toISOString().split('T')[0]);
  if (next && isEditor) {
    await db.ref("activity/" + next).set({ people: weekData.people || [], entries: {} });
    loadWeek(next);
  }
}

async function openArchive() {
  const snap = await db.ref("activity").once("value");
  const keys = Object.keys(snap.val() || {}).sort().reverse();
  const choice = prompt("–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã:\n" + keys.join("\n"));
  if (choice && keys.includes(choice)) loadWeek(choice);
}
</script>
</body>
</html>
